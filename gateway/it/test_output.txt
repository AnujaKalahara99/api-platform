COMPOSE_FILE=docker-compose.test.postgres.yaml /Library/Developer/CommandLineTools/usr/bin/make test
COMPOSE_FILE=docker-compose.test.postgres.yaml go test -v -timeout 30m ./...
=== RUN   TestFeatures
2026/02/09 14:06:25 Setting up test reporter...
2026/02/09 14:06:25 Reports directory ready at reports
2026/02/09 14:06:25 === Integration Test Suite Starting ===
2026/02/09 14:06:25 Setting up coverage collection directories...
2026/02/09 14:06:25 Cleaned existing coverage data
2026/02/09 14:06:25 Coverage directories created at coverage
2026/02/09 14:06:25 Colima detected, setting up environment variables...
2026/02/09 14:06:25 Set DOCKER_HOST=unix:///Users/tharsanan/.colima/default/docker.sock
2026/02/09 14:06:25 Set TESTCONTAINERS_RYUK_DISABLED=true
2026/02/09 14:06:25 Using compose file: /Users/tharsanan/Documents/worktrees/api-platform/postgres/gateway/it/docker-compose.test.postgres.yaml
2026/02/09 14:06:25 github.com/testcontainers/testcontainers-go - Connected to docker: 
  Server Version: 28.4.0
  API Version: 1.51
  Operating System: Ubuntu 24.04.2 LTS
  Total Memory: 1959 MB
  Testcontainers for Go Version: v0.40.0
  Resolved Docker Host: unix:///Users/tharsanan/.colima/default/docker.sock
  Resolved Docker Socket Path: /Users/tharsanan/.colima/default/docker.sock
  Test SessionID: 14088f97a28faa71a987704fd34e700cb9a7fc77dd60e409e308ba7f9c2db906
  Test ProcessID: 49c07910-f2ea-4739-87f9-0f7bba6137ee
2026/02/09 14:06:25 Starting Docker Compose services...
 Network gateway-it_it-gateway-network  Creating
 Network gateway-it_it-gateway-network  Created
 Volume gateway-it_controller-data-tests  Creating
 Volume gateway-it_controller-data-tests  Created
 Container it-mock-azure-content-safety  Creating
 Container it-mock-embedding-provider  Creating
 Container mcp-server-backend  Creating
 Container it-mock-analytics-collector  Creating
 Container it-echo-backend  Creating
 Container it-sample-backend  Creating
 Container it-postgres  Creating
 Container it-mock-jwks  Creating
 Container it-mock-openapi  Creating
 Container it-policy-engine  Creating
 Container it-redis  Creating
 Container it-mock-aws-bedrock-guardrail  Creating
 Container it-mock-aws-bedrock-guardrail  Created
 Container it-mock-jwks  Created
 echo-backend The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested 
 Container it-policy-engine  Created
 Container it-echo-backend  Created
 Container it-sample-backend  Created
 Container it-mock-analytics-collector  Created
 Container it-mock-embedding-provider  Created
 Container it-mock-azure-content-safety  Created
 Container mcp-server-backend  Created
 Container it-postgres  Created
 Container it-gateway-controller  Creating
 Container it-redis  Created
 mock-openapi The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested 
 Container it-mock-openapi  Created
 Container it-mock-openapi-https  Creating
 Container it-gateway-controller  Created
 Container it-router  Creating
 Container it-mock-openapi-https  Created
 Container it-router  Created
 Container it-redis  Starting
 Container it-mock-jwks  Starting
 Container it-policy-engine  Starting
 Container it-mock-azure-content-safety  Starting
 Container it-mock-aws-bedrock-guardrail  Starting
 Container it-mock-analytics-collector  Starting
 Container it-echo-backend  Starting
 Container it-sample-backend  Starting
 Container it-mock-embedding-provider  Starting
 Container mcp-server-backend  Starting
 Container it-postgres  Starting
 Container it-mock-openapi  Starting
 Container it-mock-azure-content-safety  Started
 Container it-postgres  Started
 Container it-postgres  Waiting
 Container it-policy-engine  Started
 Container it-sample-backend  Started
 Container mcp-server-backend  Started
 Container it-mock-openapi  Started
 Container it-mock-openapi  Waiting
 Container it-mock-embedding-provider  Started
 Container it-redis  Started
 Container it-echo-backend  Started
 Container it-mock-jwks  Started
 Container it-mock-analytics-collector  Started
 Container it-mock-aws-bedrock-guardrail  Started
 Container it-postgres  Healthy
 Container it-gateway-controller  Starting
 Container it-gateway-controller  Started
 Container it-gateway-controller  Waiting
 Container it-mock-openapi  Waiting
 Container it-gateway-controller  Healthy
 Container it-mock-openapi  Healthy
 Container it-mock-openapi-https  Starting
 Container it-mock-openapi  Healthy
 Container it-router  Starting
 Container it-mock-openapi-https  Started
 Container it-router  Started
 Container it-mock-openapi  Waiting
 Container it-gateway-controller  Waiting
 Container it-postgres  Waiting
 Container it-echo-backend  Waiting
 Container it-mock-analytics-collector  Waiting
 Container it-redis  Waiting
 Container it-router  Waiting
 Container it-mock-azure-content-safety  Waiting
 Container mcp-server-backend  Waiting
 Container it-sample-backend  Waiting
 Container it-mock-embedding-provider  Waiting
 Container it-mock-jwks  Waiting
 Container it-mock-openapi-https  Waiting
 Container it-policy-engine  Waiting
 Container it-mock-aws-bedrock-guardrail  Waiting
 Container it-mock-analytics-collector  Healthy
 Container it-redis  Healthy
 Container it-mock-openapi  Healthy
 Container it-gateway-controller  Healthy
 Container it-policy-engine  Healthy
 Container it-postgres  Healthy
 Container it-mock-openapi-https  Healthy
 Container it-mock-aws-bedrock-guardrail  Healthy
 Container it-echo-backend  Healthy
 Container mcp-server-backend  Healthy
 Container it-mock-jwks  Healthy
 Container it-sample-backend  Healthy
 Container it-mock-embedding-provider  Healthy
 Container it-mock-azure-content-safety  Healthy
 Container it-router  Healthy
2026/02/09 14:06:54 Docker Compose services started, waiting for health checks...
2026/02/09 14:06:56 Service gateway-controller is healthy
2026/02/09 14:06:56 Service router is healthy
2026/02/09 14:06:56 All services are healthy and ready
2026/02/09 14:06:56 === Test Suite Ready ===
[1;37mFeature:[0m Gateway Health Check
  As an operator
  I want to verify that gateway services are healthy
  So that I can ensure the gateway is operational
=== RUN   TestFeatures/Gateway_controller_health_endpoint_returns_OK
2026/02/09 14:06:56 Starting scenario: Gateway controller health endpoint returns OK

  [1;37mBackground:[0m
    [32mGiven[0m [32mthe gateway services are running[0m                              [1;30m# <autogenerated>:1 -> *HealthSteps[0m
REQUEST:
GET /health HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Accept-Encoding: gzip


2026/02/09 14:06:56 DEBUG: Sending GET request to http://localhost:9090/health
2026/02/09 14:06:56 DEBUG: Received response from http://localhost:9090/health: status=200

  [1;37mScenario:[0m Gateway controller health endpoint returns OK               [1;30m# features/health.feature:27[0m
    [32mWhen[0m [32mI send a GET request to the gateway controller health endpoint[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                         [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:06:56 Scenario passed: Gateway controller health endpoint returns OK
    [32mAnd[0m [32mthe response should indicate healthy status[0m                     [1;30m# <autogenerated>:1 -> *HealthSteps[0m
=== RUN   TestFeatures/Router_is_ready_to_accept_traffic
2026/02/09 14:06:56 Starting scenario: Router is ready to accept traffic
REQUEST:
GET /ready HTTP/1.1
Host: localhost:9901
User-Agent: Go-http-client/1.1
Accept-Encoding: gzip


2026/02/09 14:06:56 DEBUG: Sending GET request to http://localhost:9901/ready
2026/02/09 14:06:56 DEBUG: Received response from http://localhost:9901/ready: status=200

  [1;37mScenario:[0m Router is ready to accept traffic              [1;30m# features/health.feature:32[0m
    [32mWhen[0m [32mI send a GET request to the router ready endpoint[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:06:56 Scenario passed: Router is ready to accept traffic
    [32mThen[0m [32mthe response status code should be 200[0m            [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/All_gateway_services_are_healthy
2026/02/09 14:06:56 Starting scenario: All gateway services are healthy

  [1;37mScenario:[0m All gateway services are healthy        [1;30m# features/health.feature:36[0m
    [32mWhen[0m [32mI check the health of all gateway services[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:06:56 Scenario passed: All gateway services are healthy
    [32mThen[0m [32mall services should report healthy status[0m  [1;30m# <autogenerated>:1 -> *HealthSteps[0m
=== RUN   TestFeatures/Gateway_controller_health_endpoint_returns_valid_JSON
2026/02/09 14:06:56 Starting scenario: Gateway controller health endpoint returns valid JSON
REQUEST:
GET /health HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Accept-Encoding: gzip


2026/02/09 14:06:56 DEBUG: Sending GET request to http://localhost:9090/health
2026/02/09 14:06:56 DEBUG: Received response from http://localhost:9090/health: status=200

  [1;37mScenario:[0m Gateway controller health endpoint returns valid JSON       [1;30m# features/health.feature:42[0m
    [32mWhen[0m [32mI send a GET request to the gateway controller health endpoint[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                         [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:06:56 Scenario passed: Gateway controller health endpoint returns valid JSON
    [32mAnd[0m [32mthe response should be valid JSON[0m                               [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Gateway_controller_health_endpoint_is_accessible_without_authentication
2026/02/09 14:06:56 Starting scenario: Gateway controller health endpoint is accessible without authentication
REQUEST:
GET /health HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Accept-Encoding: gzip


2026/02/09 14:06:56 DEBUG: Sending GET request to http://localhost:9090/health
2026/02/09 14:06:56 DEBUG: Received response from http://localhost:9090/health: status=200

  [1;37mScenario:[0m Gateway controller health endpoint is accessible without authentication [1;30m# features/health.feature:47[0m
    [32mWhen[0m [32mI send a GET request to the gateway controller health endpoint[0m             [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:06:56 Scenario passed: Gateway controller health endpoint is accessible without authentication
    [32mThen[0m [32mthe response status code should be 200[0m                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m

[1;37mFeature:[0m API Deployment and Invocation
  As an API developer
  I want to deploy an API configuration and invoke it
  So that I can verify the gateway routes requests correctly
=== RUN   TestFeatures/Deploy_a_simple_HTTP_API_and_invoke_it_successfully
2026/02/09 14:06:56 Starting scenario: Deploy a simple HTTP API and invoke it successfully

  [1;37mBackground:[0m
    [32mGiven[0m [32mthe gateway services are running[0m                                       [1;30m# <autogenerated>:1 -> *HealthSteps[0m

  [1;37mScenario:[0m Deploy a simple HTTP API and invoke it successfully                  [1;30m# features/api_deploy.feature:27[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                             [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 402
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: weather-api-v1.0
spec:
  displayName: Weather-API
  version: v1.0
  context: /weather/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v2
  operations:
    - method: GET
      path: /{country_code}/{city}
    - method: GET
      path: /alerts/active
    - method: POST
      path: /alerts/active
2026/02/09 14:06:56 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:06:56 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                        [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: weather-api-v1.0[0m
      [36mspec:[0m
      [36m  displayName: Weather-API[0m
      [36m  version: v1.0[0m
      [36m  context: /weather/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v2[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /{country_code}/{city}[0m
      [36m    - method: GET[0m
      [36m      path: /alerts/active[0m
      [36m    - method: POST[0m
      [36m      path: /alerts/active[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response should be valid JSON[0m                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe JSON response field "status" should be "success"[0m                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for 2 seconds[0m                                                     [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
REQUEST:
GET /weather/v1.0/us/seattle HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:06:59 DEBUG: Sending GET request to http://localhost:8080/weather/v1.0/us/seattle
2026/02/09 14:06:59 DEBUG: Received response from http://localhost:8080/weather/v1.0/us/seattle: status=200
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/weather/v1.0/us/seattle"[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response should be successful[0m                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response should be valid JSON[0m                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response body should contain "/api/v2/us/seattle"[0m                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                             [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
DELETE /apis/weather-api-v1.0 HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:06:59 DEBUG: Sending DELETE request to http://localhost:9090/apis/weather-api-v1.0
2026/02/09 14:06:59 DEBUG: Received response from http://localhost:9090/apis/weather-api-v1.0: status=200
    [32mWhen[0m [32mI delete the API "weather-api-v1.0"[0m                                     [1;30m# steps_api.go:47 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func2[0m
    [32mThen[0m [32mthe response should be successful[0m                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response should be valid JSON[0m                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:06:59 Scenario passed: Deploy a simple HTTP API and invoke it successfully
    [32mAnd[0m [32mthe JSON response field "status" should be "success"[0m                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Deploy_an_HTTP_API_with_labels_and_verify_they_are_stored
2026/02/09 14:06:59 Starting scenario: Deploy an HTTP API with labels and verify they are stored

  [1;37mScenario:[0m Deploy an HTTP API with labels and verify they are stored                                  [1;30m# features/api_deploy.feature:65[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                   [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 366
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: labeled-api-v1.0
  labels:
    environment: production
    team: backend
    version: v1
spec:
  displayName: Labeled-API
  version: v1.0
  context: /labeled/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v2
  operations:
    - method: GET
      path: /test
2026/02/09 14:06:59 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:06:59 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                              [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: labeled-api-v1.0[0m
      [36m  labels:[0m
      [36m    environment: production[0m
      [36m    team: backend[0m
      [36m    version: v1[0m
      [36mspec:[0m
      [36m  displayName: Labeled-API[0m
      [36m  version: v1.0[0m
      [36m  context: /labeled/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v2[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /test[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response should be valid JSON[0m                                                              [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe JSON response field "status" should be "success"[0m                                           [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for 2 seconds[0m                                                                           [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                   [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
GET /apis/labeled-api-v1.0 HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:02 DEBUG: Sending GET request to http://localhost:9090/apis/labeled-api-v1.0
2026/02/09 14:07:02 DEBUG: Received response from http://localhost:9090/apis/labeled-api-v1.0: status=200
    [32mWhen[0m [32mI get the API "labeled-api-v1.0"[0m                                                              [1;30m# steps_api.go:79 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func5[0m
    [32mThen[0m [32mthe response should be successful[0m                                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response should be valid JSON[0m                                                              [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe JSON response field "api.configuration.metadata.labels.environment" should be "production"[0m [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe JSON response field "api.configuration.metadata.labels.team" should be "backend"[0m           [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe JSON response field "api.configuration.metadata.labels.version" should be "v1"[0m             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                   [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
DELETE /apis/labeled-api-v1.0 HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:02 DEBUG: Sending DELETE request to http://localhost:9090/apis/labeled-api-v1.0
2026/02/09 14:07:02 DEBUG: Received response from http://localhost:9090/apis/labeled-api-v1.0: status=200
    [32mWhen[0m [32mI delete the API "labeled-api-v1.0"[0m                                                           [1;30m# steps_api.go:47 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func2[0m
2026/02/09 14:07:02 Scenario passed: Deploy an HTTP API with labels and verify they are stored
    [32mThen[0m [32mthe response should be successful[0m                                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Deploy_an_HTTP_API_with_invalid_labels_(spaces_in_keys)_should_fail
2026/02/09 14:07:02 Starting scenario: Deploy an HTTP API with invalid labels (spaces in keys) should fail

  [1;37mScenario:[0m Deploy an HTTP API with invalid labels (spaces in keys) should fail [1;30m# features/api_deploy.feature:105[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                            [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 358
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: invalid-labels-api-v1.0
  labels:
    "My Label": value
    team: backend
spec:
  displayName: Invalid-Labels-API
  version: v1.0
  context: /invalid/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v2
  operations:
    - method: GET
      path: /test
2026/02/09 14:07:02 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:02 DEBUG: Received response from http://localhost:9090/apis: status=400
    [32mWhen[0m [32mI deploy this API configuration:[0m                                       [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: invalid-labels-api-v1.0[0m
      [36m  labels:[0m
      [36m    "My Label": value[0m
      [36m    team: backend[0m
      [36mspec:[0m
      [36m  displayName: Invalid-Labels-API[0m
      [36m  version: v1.0[0m
      [36m  context: /invalid/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v2[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /test[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be a client error[0m                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response should be valid JSON[0m                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe JSON response field "status" should be "error"[0m                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:03 Scenario passed: Deploy an HTTP API with invalid labels (spaces in keys) should fail
    [32mAnd[0m [32mthe response body should contain "Configuration validation failed"[0m      [1;30m# <autogenerated>:1 -> *AssertSteps[0m

[1;37mFeature:[0m Rate Limiting
  As an API developer
  I want to limit the rate of requests to my API
  So that I can protect my upstream services from excessive traffic
=== RUN   TestFeatures/Enforce_rate_limit_on_API_resource
2026/02/09 14:07:03 Starting scenario: Enforce rate limit on API resource

  [1;37mBackground:[0m
    [32mGiven[0m [32mthe gateway services are running[0m                                                 [1;30m# <autogenerated>:1 -> *HealthSteps[0m

  [1;37mScenario:[0m Enforce rate limit on API resource                                             [1;30m# features/ratelimit.feature:28[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                       [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 544
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-test-api
spec:
  displayName: RateLimit Test API
  version: v1.0
  context: /ratelimit/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /limited
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: request-limit
                limits:
                  - limit: 10
                    duration: "1h"
2026/02/09 14:07:03 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:03 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                  [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-test-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Test API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /limited[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: request-limit[0m
      [36m                limits:[0m
      [36m                  - limit: 10[0m
      [36m                    duration: "1h"[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                 [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit/v1.0/limited" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:03 DEBUG: Sending 8 GET requests to http://localhost:8080/ratelimit/v1.0/limited
REQUEST:
GET /ratelimit/v1.0/limited HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:03 DEBUG: Sending GET request to http://localhost:8080/ratelimit/v1.0/limited
2026/02/09 14:07:03 DEBUG: Received response from http://localhost:8080/ratelimit/v1.0/limited: status=200
2026/02/09 14:07:03 DEBUG: Request 1/8 completed, last response status: 200
REQUEST:
GET /ratelimit/v1.0/limited HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:03 DEBUG: Sending GET request to http://localhost:8080/ratelimit/v1.0/limited
2026/02/09 14:07:03 DEBUG: Received response from http://localhost:8080/ratelimit/v1.0/limited: status=200
2026/02/09 14:07:03 DEBUG: Request 2/8 completed, last response status: 200
REQUEST:
GET /ratelimit/v1.0/limited HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:03 DEBUG: Sending GET request to http://localhost:8080/ratelimit/v1.0/limited
2026/02/09 14:07:03 DEBUG: Received response from http://localhost:8080/ratelimit/v1.0/limited: status=200
2026/02/09 14:07:03 DEBUG: Request 3/8 completed, last response status: 200
REQUEST:
GET /ratelimit/v1.0/limited HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:03 DEBUG: Sending GET request to http://localhost:8080/ratelimit/v1.0/limited
2026/02/09 14:07:03 DEBUG: Received response from http://localhost:8080/ratelimit/v1.0/limited: status=200
2026/02/09 14:07:03 DEBUG: Request 4/8 completed, last response status: 200
REQUEST:
GET /ratelimit/v1.0/limited HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:03 DEBUG: Sending GET request to http://localhost:8080/ratelimit/v1.0/limited
2026/02/09 14:07:03 DEBUG: Received response from http://localhost:8080/ratelimit/v1.0/limited: status=200
2026/02/09 14:07:03 DEBUG: Request 5/8 completed, last response status: 200
REQUEST:
GET /ratelimit/v1.0/limited HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:03 DEBUG: Sending GET request to http://localhost:8080/ratelimit/v1.0/limited
2026/02/09 14:07:03 DEBUG: Received response from http://localhost:8080/ratelimit/v1.0/limited: status=200
2026/02/09 14:07:03 DEBUG: Request 6/8 completed, last response status: 200
REQUEST:
GET /ratelimit/v1.0/limited HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:03 DEBUG: Sending GET request to http://localhost:8080/ratelimit/v1.0/limited
2026/02/09 14:07:03 DEBUG: Received response from http://localhost:8080/ratelimit/v1.0/limited: status=200
2026/02/09 14:07:03 DEBUG: Request 7/8 completed, last response status: 200
REQUEST:
GET /ratelimit/v1.0/limited HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:03 DEBUG: Sending GET request to http://localhost:8080/ratelimit/v1.0/limited
2026/02/09 14:07:03 DEBUG: Received response from http://localhost:8080/ratelimit/v1.0/limited: status=200
2026/02/09 14:07:03 DEBUG: Request 8/8 completed, last response status: 200
2026/02/09 14:07:03 DEBUG: All 8 requests completed, final response status: 200
    [32mWhen[0m [32mI send 8 GET requests to "http://localhost:8080/ratelimit/v1.0/limited"[0m           [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                            [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:03 DEBUG: Sending 2 GET requests to http://localhost:8080/ratelimit/v1.0/limited
REQUEST:
GET /ratelimit/v1.0/limited HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:03 DEBUG: Sending GET request to http://localhost:8080/ratelimit/v1.0/limited
2026/02/09 14:07:03 DEBUG: Received response from http://localhost:8080/ratelimit/v1.0/limited: status=200
2026/02/09 14:07:03 DEBUG: Request 1/2 completed, last response status: 200
REQUEST:
GET /ratelimit/v1.0/limited HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:03 DEBUG: Sending GET request to http://localhost:8080/ratelimit/v1.0/limited
2026/02/09 14:07:03 DEBUG: Received response from http://localhost:8080/ratelimit/v1.0/limited: status=429
2026/02/09 14:07:03 DEBUG: Request 2/2 completed, last response status: 429
2026/02/09 14:07:03 DEBUG: All 2 requests completed, final response status: 429
    [32mWhen[0m [32mI send 2 GET requests to "http://localhost:8080/ratelimit/v1.0/limited"[0m           [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                            [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:03 Scenario passed: Enforce rate limit on API resource
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Multi-quota_rate_limit_headers_in_IETF_format
2026/02/09 14:07:03 Starting scenario: Multi-quota rate limit headers in IETF format

  [1;37mScenario:[0m Multi-quota rate limit headers in IETF format                                                     [1;30m# features/ratelimit.feature:68[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                          [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 744
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-multi-quota-headers-api
spec:
  displayName: RateLimit Multi-Quota Headers API
  version: v1.0
  context: /ratelimit-multi-quota-headers/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: burst
                limits:
                  - limit: 10
                    duration: "1m"
              - name: daily
                limits:
                  - limit: 100
                    duration: "24h"
2026/02/09 14:07:03 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:03 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                     [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-multi-quota-headers-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Multi-Quota Headers API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-multi-quota-headers/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: burst[0m
      [36m                limits:[0m
      [36m                  - limit: 10[0m
      [36m                    duration: "1m"[0m
      [36m              - name: daily[0m
      [36m                limits:[0m
      [36m                  - limit: 100[0m
      [36m                    duration: "24h"[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-multi-quota-headers/v1.0/health" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
REQUEST:
GET /ratelimit-multi-quota-headers/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:04 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multi-quota-headers/v1.0/resource
2026/02/09 14:07:04 DEBUG: Received response from http://localhost:8080/ratelimit-multi-quota-headers/v1.0/resource: status=200
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-multi-quota-headers/v1.0/resource"[0m          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                               [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Limit" should exist[0m                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should exist[0m                                              [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Reset" should exist[0m                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "RateLimit-Policy" should exist[0m                                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "RateLimit" should exist[0m                                                          [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "RateLimit-Policy" should contain "burst"[0m                                         [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "RateLimit-Policy" should contain "daily"[0m                                         [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "RateLimit" should contain "burst"[0m                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:04 Scenario passed: Multi-quota rate limit headers in IETF format
    [32mAnd[0m [32mthe response header "RateLimit" should contain "daily"[0m                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/429_response_includes_IETF_RateLimit_headers_for_violated_quota
2026/02/09 14:07:04 Starting scenario: 429 response includes IETF RateLimit headers for violated quota

  [1;37mScenario:[0m 429 response includes IETF RateLimit headers for violated quota                               [1;30m# features/ratelimit.feature:120[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                      [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 739
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-multi-quota-429-api
spec:
  displayName: RateLimit Multi-Quota 429 API
  version: v1.0
  context: /ratelimit-multi-quota-429/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: request-limit
                limits:
                  - limit: 4
                    duration: "1h"
              - name: daily
                limits:
                  - limit: 100
                    duration: "24h"
2026/02/09 14:07:04 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:04 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                 [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-multi-quota-429-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Multi-Quota 429 API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-multi-quota-429/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: request-limit[0m
      [36m                limits:[0m
      [36m                  - limit: 4[0m
      [36m                    duration: "1h"[0m
      [36m              - name: daily[0m
      [36m                limits:[0m
      [36m                  - limit: 100[0m
      [36m                    duration: "24h"[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-multi-quota-429/v1.0/health" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:04 DEBUG: Sending 4 GET requests to http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource
REQUEST:
GET /ratelimit-multi-quota-429/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:04 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource
2026/02/09 14:07:04 DEBUG: Received response from http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource: status=200
2026/02/09 14:07:04 DEBUG: Request 1/4 completed, last response status: 200
REQUEST:
GET /ratelimit-multi-quota-429/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:04 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource
2026/02/09 14:07:04 DEBUG: Received response from http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource: status=200
2026/02/09 14:07:04 DEBUG: Request 2/4 completed, last response status: 200
REQUEST:
GET /ratelimit-multi-quota-429/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:04 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource
2026/02/09 14:07:04 DEBUG: Received response from http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource: status=200
2026/02/09 14:07:04 DEBUG: Request 3/4 completed, last response status: 200
REQUEST:
GET /ratelimit-multi-quota-429/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:04 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource
2026/02/09 14:07:04 DEBUG: Received response from http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource: status=200
2026/02/09 14:07:04 DEBUG: Request 4/4 completed, last response status: 200
2026/02/09 14:07:04 DEBUG: All 4 requests completed, final response status: 200
    [32mWhen[0m [32mI send 4 GET requests to "http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource"[0m         [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                           [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-multi-quota-429/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:04 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource
2026/02/09 14:07:04 DEBUG: Received response from http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-multi-quota-429/v1.0/resource"[0m          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                           [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Quota" should be "request-limit"[0m                                 [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "RateLimit-Policy" should exist[0m                                               [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "RateLimit-Policy" should contain "request-limit"[0m                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "RateLimit" should exist[0m                                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "RateLimit" should contain "request-limit"[0m                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:04 Scenario passed: 429 response includes IETF RateLimit headers for violated quota
    [32mAnd[0m [32mthe response header "Retry-After" should exist[0m                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Rate_limit_headers_are_returned
2026/02/09 14:07:04 Starting scenario: Rate limit headers are returned

  [1;37mScenario:[0m Rate limit headers are returned                                                      [1;30m# features/ratelimit.feature:172[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                             [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 557
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-headers-api
spec:
  displayName: RateLimit Headers API
  version: v1.0
  context: /ratelimit-headers/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /check
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: request-limit
                limits:
                  - limit: 100
                    duration: "1h"
2026/02/09 14:07:04 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:04 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                        [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-headers-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Headers API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-headers/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /check[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: request-limit[0m
      [36m                limits:[0m
      [36m                  - limit: 100[0m
      [36m                    duration: "1h"[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-headers/v1.0/check" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
REQUEST:
GET /ratelimit-headers/v1.0/check HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:05 DEBUG: Sending GET request to http://localhost:8080/ratelimit-headers/v1.0/check
2026/02/09 14:07:05 DEBUG: Received response from http://localhost:8080/ratelimit-headers/v1.0/check: status=200
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-headers/v1.0/check"[0m            [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Limit" should be "100"[0m                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should exist[0m                                 [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:05 Scenario passed: Rate limit headers are returned
    [32mAnd[0m [32mthe response header "X-RateLimit-Reset" should exist[0m                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Custom_rate_limit_error_response
2026/02/09 14:07:05 Starting scenario: Custom rate limit error response

  [1;37mScenario:[0m Custom rate limit error response                                                     [1;30m# features/ratelimit.feature:209[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                             [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 716
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-custom-api
spec:
  displayName: RateLimit Custom API
  version: v1.0
  context: /ratelimit-custom/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /custom
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: request-limit
                limits:
                  - limit: 5
                    duration: "1h"
            onRateLimitExceeded:
              statusCode: 429
              body: '{"error": "Too Many Requests", "code": 429001}'
              bodyFormat: json
2026/02/09 14:07:05 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:05 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                        [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-custom-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Custom API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-custom/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /custom[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: request-limit[0m
      [36m                limits:[0m
      [36m                  - limit: 5[0m
      [36m                    duration: "1h"[0m
      [36m            onRateLimitExceeded:[0m
      [36m              statusCode: 429[0m
      [36m              body: '{"error": "Too Many Requests", "code": 429001}'[0m
      [36m              bodyFormat: json[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-custom/v1.0/custom" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:05 DEBUG: Sending 5 GET requests to http://localhost:8080/ratelimit-custom/v1.0/custom
REQUEST:
GET /ratelimit-custom/v1.0/custom HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:05 DEBUG: Sending GET request to http://localhost:8080/ratelimit-custom/v1.0/custom
2026/02/09 14:07:05 DEBUG: Received response from http://localhost:8080/ratelimit-custom/v1.0/custom: status=200
2026/02/09 14:07:05 DEBUG: Request 1/5 completed, last response status: 200
REQUEST:
GET /ratelimit-custom/v1.0/custom HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:05 DEBUG: Sending GET request to http://localhost:8080/ratelimit-custom/v1.0/custom
2026/02/09 14:07:05 DEBUG: Received response from http://localhost:8080/ratelimit-custom/v1.0/custom: status=200
2026/02/09 14:07:05 DEBUG: Request 2/5 completed, last response status: 200
REQUEST:
GET /ratelimit-custom/v1.0/custom HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:05 DEBUG: Sending GET request to http://localhost:8080/ratelimit-custom/v1.0/custom
2026/02/09 14:07:05 DEBUG: Received response from http://localhost:8080/ratelimit-custom/v1.0/custom: status=200
2026/02/09 14:07:05 DEBUG: Request 3/5 completed, last response status: 200
REQUEST:
GET /ratelimit-custom/v1.0/custom HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:05 DEBUG: Sending GET request to http://localhost:8080/ratelimit-custom/v1.0/custom
2026/02/09 14:07:05 DEBUG: Received response from http://localhost:8080/ratelimit-custom/v1.0/custom: status=200
2026/02/09 14:07:05 DEBUG: Request 4/5 completed, last response status: 200
REQUEST:
GET /ratelimit-custom/v1.0/custom HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:05 DEBUG: Sending GET request to http://localhost:8080/ratelimit-custom/v1.0/custom
2026/02/09 14:07:05 DEBUG: Received response from http://localhost:8080/ratelimit-custom/v1.0/custom: status=429
2026/02/09 14:07:05 DEBUG: Request 5/5 completed, last response status: 429
2026/02/09 14:07:05 DEBUG: All 5 requests completed, final response status: 429
    [32mWhen[0m [32mI send 5 GET requests to "http://localhost:8080/ratelimit-custom/v1.0/custom"[0m           [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response should be valid JSON[0m                                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe JSON response field "error" should be "Too Many Requests"[0m                            [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:05 Scenario passed: Custom rate limit error response
    [32mAnd[0m [32mthe JSON response field "code" should be 429001[0m                                          [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Basic_rate_limiting_without_cost_extraction
2026/02/09 14:07:05 Starting scenario: Basic rate limiting without cost extraction

  [1;37mScenario:[0m Basic rate limiting without cost extraction                                           [1;30m# features/ratelimit.feature:251[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                              [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 552
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-basic-api
spec:
  displayName: RateLimit Basic API
  version: v1.0
  context: /ratelimit-basic/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: request-limit
                limits:
                  - limit: 4
                    duration: "1h"
2026/02/09 14:07:05 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:05 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                         [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-basic-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Basic API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-basic/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: request-limit[0m
      [36m                limits:[0m
      [36m                  - limit: 4[0m
      [36m                    duration: "1h"[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-basic/v1.0/resource" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:06 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-basic/v1.0/resource
REQUEST:
GET /ratelimit-basic/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:06 DEBUG: Sending GET request to http://localhost:8080/ratelimit-basic/v1.0/resource
2026/02/09 14:07:06 DEBUG: Received response from http://localhost:8080/ratelimit-basic/v1.0/resource: status=200
2026/02/09 14:07:06 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-basic/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:06 DEBUG: Sending GET request to http://localhost:8080/ratelimit-basic/v1.0/resource
2026/02/09 14:07:06 DEBUG: Received response from http://localhost:8080/ratelimit-basic/v1.0/resource: status=200
2026/02/09 14:07:06 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-basic/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:06 DEBUG: Sending GET request to http://localhost:8080/ratelimit-basic/v1.0/resource
2026/02/09 14:07:06 DEBUG: Received response from http://localhost:8080/ratelimit-basic/v1.0/resource: status=200
2026/02/09 14:07:06 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:06 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-basic/v1.0/resource"[0m           [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-basic/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:06 DEBUG: Sending GET request to http://localhost:8080/ratelimit-basic/v1.0/resource
2026/02/09 14:07:06 DEBUG: Received response from http://localhost:8080/ratelimit-basic/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-basic/v1.0/resource"[0m            [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:06 Scenario passed: Basic rate limiting without cost extraction
    [32mThen[0m [32mthe response status code should be 429[0m                                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Cost_extraction_from_response_body_using_echo_backend
2026/02/09 14:07:06 Starting scenario: Cost extraction from response body using echo backend

  [1;37mScenario:[0m Cost extraction from response body using echo backend                                            [1;30m# features/ratelimit.feature:290[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                         [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 827
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-cost-extraction-api
spec:
  displayName: RateLimit Cost Extraction API
  version: v1.0
  context: /ratelimit-cost-extraction/$version
  upstream:
    main:
      url: http://echo-backend:80
  operations:
    - method: GET
      path: /anything
    - method: POST
      path: /anything
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: token-quota
                limits:
                  - limit: 100
                    duration: "1h"
                costExtraction:
                  enabled: true
                  sources:
                    - type: response_body
                      jsonPath: "$.json.custom_cost"
                  default: 1
2026/02/09 14:07:06 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:06 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                    [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-cost-extraction-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Cost Extraction API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-cost-extraction/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://echo-backend:80[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /anything[0m
      [36m    - method: POST[0m
      [36m      path: /anything[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: token-quota[0m
      [36m                limits:[0m
      [36m                  - limit: 100[0m
      [36m                    duration: "1h"[0m
      [36m                costExtraction:[0m
      [36m                  enabled: true[0m
      [36m                  sources:[0m
      [36m                    - type: response_body[0m
      [36m                      jsonPath: "$.json.custom_cost"[0m
      [36m                  default: 1[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-cost-extraction/v1.0/anything" to be ready[0m  [1;30m# <autogenerated>:1 -> *HealthSteps[0m
REQUEST:
POST /ratelimit-cost-extraction/v1.0/anything HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 19
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

{"custom_cost": 50}
2026/02/09 14:07:07 DEBUG: Sending POST request to http://localhost:8080/ratelimit-cost-extraction/v1.0/anything
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-cost-extraction/v1.0/anything: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-cost-extraction/v1.0/anything" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"custom_cost": 50}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                              [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should be "50"[0m                                           [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-cost-extraction/v1.0/anything HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 19
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

{"custom_cost": 50}
2026/02/09 14:07:07 DEBUG: Sending POST request to http://localhost:8080/ratelimit-cost-extraction/v1.0/anything
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-cost-extraction/v1.0/anything: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-cost-extraction/v1.0/anything" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"custom_cost": 50}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                              [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should be "0"[0m                                            [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-cost-extraction/v1.0/anything HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 19
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

{"custom_cost": 10}
2026/02/09 14:07:07 DEBUG: Sending POST request to http://localhost:8080/ratelimit-cost-extraction/v1.0/anything
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-cost-extraction/v1.0/anything: status=429
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-cost-extraction/v1.0/anything" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"custom_cost": 10}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                              [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:07 Scenario passed: Cost extraction from response body using echo backend
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                               [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/API-level_rate_limiting_with_apiname_key_extraction
2026/02/09 14:07:07 Starting scenario: API-level rate limiting with apiname key extraction

  [1;37mScenario:[0m API-level rate limiting with apiname key extraction                                     [1;30m# features/ratelimit.feature:356[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 998
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-api-level-api
spec:
  displayName: RateLimit API Level Test
  version: v1.0
  context: /ratelimit-api-level/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /route0
    - method: GET
      path: /route1
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: api-quota
                limits:
                  - limit: 10
                    duration: "1h"
                keyExtraction:
                  - type: apiname
    - method: GET
      path: /route2
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: api-quota
                limits:
                  - limit: 10
                    duration: "1h"
                keyExtraction:
                  - type: apiname
2026/02/09 14:07:07 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                           [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-api-level-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit API Level Test[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-api-level/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /route0[0m
      [36m    - method: GET[0m
      [36m      path: /route1[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: api-quota[0m
      [36m                limits:[0m
      [36m                  - limit: 10[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: apiname[0m
      [36m    - method: GET[0m
      [36m      path: /route2[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: api-quota[0m
      [36m                limits:[0m
      [36m                  - limit: 10[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: apiname[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                          [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-api-level/v1.0/route0" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:07 DEBUG: Sending 5 GET requests to http://localhost:8080/ratelimit-api-level/v1.0/route1
REQUEST:
GET /ratelimit-api-level/v1.0/route1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:07 DEBUG: Sending GET request to http://localhost:8080/ratelimit-api-level/v1.0/route1
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-api-level/v1.0/route1: status=200
2026/02/09 14:07:07 DEBUG: Request 1/5 completed, last response status: 200
REQUEST:
GET /ratelimit-api-level/v1.0/route1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:07 DEBUG: Sending GET request to http://localhost:8080/ratelimit-api-level/v1.0/route1
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-api-level/v1.0/route1: status=200
2026/02/09 14:07:07 DEBUG: Request 2/5 completed, last response status: 200
REQUEST:
GET /ratelimit-api-level/v1.0/route1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:07 DEBUG: Sending GET request to http://localhost:8080/ratelimit-api-level/v1.0/route1
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-api-level/v1.0/route1: status=200
2026/02/09 14:07:07 DEBUG: Request 3/5 completed, last response status: 200
REQUEST:
GET /ratelimit-api-level/v1.0/route1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:07 DEBUG: Sending GET request to http://localhost:8080/ratelimit-api-level/v1.0/route1
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-api-level/v1.0/route1: status=200
2026/02/09 14:07:07 DEBUG: Request 4/5 completed, last response status: 200
REQUEST:
GET /ratelimit-api-level/v1.0/route1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:07 DEBUG: Sending GET request to http://localhost:8080/ratelimit-api-level/v1.0/route1
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-api-level/v1.0/route1: status=200
2026/02/09 14:07:07 DEBUG: Request 5/5 completed, last response status: 200
2026/02/09 14:07:07 DEBUG: All 5 requests completed, final response status: 200
    [32mWhen[0m [32mI send 5 GET requests to "http://localhost:8080/ratelimit-api-level/v1.0/route1"[0m           [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:07 DEBUG: Sending 4 GET requests to http://localhost:8080/ratelimit-api-level/v1.0/route2
REQUEST:
GET /ratelimit-api-level/v1.0/route2 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:07 DEBUG: Sending GET request to http://localhost:8080/ratelimit-api-level/v1.0/route2
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-api-level/v1.0/route2: status=200
2026/02/09 14:07:07 DEBUG: Request 1/4 completed, last response status: 200
REQUEST:
GET /ratelimit-api-level/v1.0/route2 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:07 DEBUG: Sending GET request to http://localhost:8080/ratelimit-api-level/v1.0/route2
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-api-level/v1.0/route2: status=200
2026/02/09 14:07:07 DEBUG: Request 2/4 completed, last response status: 200
REQUEST:
GET /ratelimit-api-level/v1.0/route2 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:07 DEBUG: Sending GET request to http://localhost:8080/ratelimit-api-level/v1.0/route2
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-api-level/v1.0/route2: status=200
2026/02/09 14:07:07 DEBUG: Request 3/4 completed, last response status: 200
REQUEST:
GET /ratelimit-api-level/v1.0/route2 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:07 DEBUG: Sending GET request to http://localhost:8080/ratelimit-api-level/v1.0/route2
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-api-level/v1.0/route2: status=200
2026/02/09 14:07:07 DEBUG: Request 4/4 completed, last response status: 200
2026/02/09 14:07:07 DEBUG: All 4 requests completed, final response status: 200
    [32mWhen[0m [32mI send 4 GET requests to "http://localhost:8080/ratelimit-api-level/v1.0/route2"[0m           [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-api-level/v1.0/route1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:07 DEBUG: Sending GET request to http://localhost:8080/ratelimit-api-level/v1.0/route1
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-api-level/v1.0/route1: status=200
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-api-level/v1.0/route1"[0m            [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-api-level/v1.0/route2 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:07 DEBUG: Sending GET request to http://localhost:8080/ratelimit-api-level/v1.0/route2
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-api-level/v1.0/route2: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-api-level/v1.0/route2"[0m            [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-api-level/v1.0/route1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:07 DEBUG: Sending GET request to http://localhost:8080/ratelimit-api-level/v1.0/route1
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:8080/ratelimit-api-level/v1.0/route1: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-api-level/v1.0/route1"[0m            [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:07 Scenario passed: API-level rate limiting with apiname key extraction
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Updating_API_does_not_reset_rate_limit_state
2026/02/09 14:07:07 Starting scenario: Updating API does not reset rate limit state

  [1;37mScenario:[0m Updating API does not reset rate limit state                                            [1;30m# features/ratelimit.feature:426[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 606
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-update-test-api
spec:
  displayName: RateLimit Update Test API
  version: v1.0
  context: /ratelimit-update-test/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /test
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: request-limit
                limits:
                  - limit: 5
                    duration: "1h"
2026/02/09 14:07:07 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:07 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                           [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-update-test-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Update Test API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-update-test/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /test[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: request-limit[0m
      [36m                limits:[0m
      [36m                  - limit: 5[0m
      [36m                    duration: "1h"[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                          [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-update-test/v1.0/test" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:08 DEBUG: Sending 5 GET requests to http://localhost:8080/ratelimit-update-test/v1.0/resource
REQUEST:
GET /ratelimit-update-test/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:08 DEBUG: Sending GET request to http://localhost:8080/ratelimit-update-test/v1.0/resource
2026/02/09 14:07:08 DEBUG: Received response from http://localhost:8080/ratelimit-update-test/v1.0/resource: status=200
2026/02/09 14:07:08 DEBUG: Request 1/5 completed, last response status: 200
REQUEST:
GET /ratelimit-update-test/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:08 DEBUG: Sending GET request to http://localhost:8080/ratelimit-update-test/v1.0/resource
2026/02/09 14:07:08 DEBUG: Received response from http://localhost:8080/ratelimit-update-test/v1.0/resource: status=200
2026/02/09 14:07:08 DEBUG: Request 2/5 completed, last response status: 200
REQUEST:
GET /ratelimit-update-test/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:08 DEBUG: Sending GET request to http://localhost:8080/ratelimit-update-test/v1.0/resource
2026/02/09 14:07:08 DEBUG: Received response from http://localhost:8080/ratelimit-update-test/v1.0/resource: status=200
2026/02/09 14:07:08 DEBUG: Request 3/5 completed, last response status: 200
REQUEST:
GET /ratelimit-update-test/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:08 DEBUG: Sending GET request to http://localhost:8080/ratelimit-update-test/v1.0/resource
2026/02/09 14:07:08 DEBUG: Received response from http://localhost:8080/ratelimit-update-test/v1.0/resource: status=200
2026/02/09 14:07:08 DEBUG: Request 4/5 completed, last response status: 200
REQUEST:
GET /ratelimit-update-test/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:08 DEBUG: Sending GET request to http://localhost:8080/ratelimit-update-test/v1.0/resource
2026/02/09 14:07:08 DEBUG: Received response from http://localhost:8080/ratelimit-update-test/v1.0/resource: status=200
2026/02/09 14:07:08 DEBUG: Request 5/5 completed, last response status: 200
2026/02/09 14:07:08 DEBUG: All 5 requests completed, final response status: 200
    [32mWhen[0m [32mI send 5 GET requests to "http://localhost:8080/ratelimit-update-test/v1.0/resource"[0m       [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-update-test/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:08 DEBUG: Sending GET request to http://localhost:8080/ratelimit-update-test/v1.0/resource
2026/02/09 14:07:08 DEBUG: Received response from http://localhost:8080/ratelimit-update-test/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-update-test/v1.0/resource"[0m        [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
PUT /apis/ratelimit-update-test-api HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 644
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-update-test-api
spec:
  displayName: RateLimit Update Test API
  version: v1.0
  context: /ratelimit-update-test/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /test
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: request-limit
                limits:
                  - limit: 5
                    duration: "1h"
    - method: PUT
      path: /handle
2026/02/09 14:07:08 DEBUG: Sending PUT request to http://localhost:9090/apis/ratelimit-update-test-api
2026/02/09 14:07:08 DEBUG: Received response from http://localhost:9090/apis/ratelimit-update-test-api: status=200
    [32mWhen[0m [32mI update the API "ratelimit-update-test-api" with this configuration:[0m                      [1;30m# steps_api.go:69 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func4[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-update-test-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Update Test API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-update-test/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /test[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: request-limit[0m
      [36m                limits:[0m
      [36m                  - limit: 5[0m
      [36m                    duration: "1h"[0m
      [36m    - method: PUT[0m
      [36m      path: /handle[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                          [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for 2 seconds[0m                                                                        [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
REQUEST:
GET /ratelimit-update-test/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:10 DEBUG: Sending GET request to http://localhost:8080/ratelimit-update-test/v1.0/resource
2026/02/09 14:07:10 DEBUG: Received response from http://localhost:8080/ratelimit-update-test/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-update-test/v1.0/resource"[0m        [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:10 Scenario passed: Updating API does not reset rate limit state
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Multi-dimensional_rate_limiting_with_quotas
2026/02/09 14:07:10 Starting scenario: Multi-dimensional rate limiting with quotas

  [1;37mScenario:[0m Multi-dimensional rate limiting with quotas                                          [1;30m# features/ratelimit.feature:507[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                             [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 1356
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-quotas-api
spec:
  displayName: RateLimit Quotas API
  version: v1.0
  context: /ratelimit-quotas/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /multi1
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: per-route
                limits:
                  - limit: 5
                    duration: "1h"
                keyExtraction:
                  - type: routename
              - name: per-api
                limits:
                  - limit: 8
                    duration: "1h"
                keyExtraction:
                  - type: apiname
    - method: GET
      path: /multi2
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: per-route
                limits:
                  - limit: 5
                    duration: "1h"
                keyExtraction:
                  - type: routename
              - name: per-api
                limits:
                  - limit: 8
                    duration: "1h"
                keyExtraction:
                  - type: apiname
2026/02/09 14:07:10 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:10 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                        [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-quotas-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Quotas API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-quotas/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /multi1[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: per-route[0m
      [36m                limits:[0m
      [36m                  - limit: 5[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: routename[0m
      [36m              - name: per-api[0m
      [36m                limits:[0m
      [36m                  - limit: 8[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: apiname[0m
      [36m    - method: GET[0m
      [36m      path: /multi2[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: per-route[0m
      [36m                limits:[0m
      [36m                  - limit: 5[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: routename[0m
      [36m              - name: per-api[0m
      [36m                limits:[0m
      [36m                  - limit: 8[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: apiname[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-quotas/v1.0/health" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:11 DEBUG: Sending 5 GET requests to http://localhost:8080/ratelimit-quotas/v1.0/multi1
REQUEST:
GET /ratelimit-quotas/v1.0/multi1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:11 DEBUG: Sending GET request to http://localhost:8080/ratelimit-quotas/v1.0/multi1
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quotas/v1.0/multi1: status=200
2026/02/09 14:07:11 DEBUG: Request 1/5 completed, last response status: 200
REQUEST:
GET /ratelimit-quotas/v1.0/multi1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:11 DEBUG: Sending GET request to http://localhost:8080/ratelimit-quotas/v1.0/multi1
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quotas/v1.0/multi1: status=200
2026/02/09 14:07:11 DEBUG: Request 2/5 completed, last response status: 200
REQUEST:
GET /ratelimit-quotas/v1.0/multi1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:11 DEBUG: Sending GET request to http://localhost:8080/ratelimit-quotas/v1.0/multi1
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quotas/v1.0/multi1: status=200
2026/02/09 14:07:11 DEBUG: Request 3/5 completed, last response status: 200
REQUEST:
GET /ratelimit-quotas/v1.0/multi1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:11 DEBUG: Sending GET request to http://localhost:8080/ratelimit-quotas/v1.0/multi1
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quotas/v1.0/multi1: status=200
2026/02/09 14:07:11 DEBUG: Request 4/5 completed, last response status: 200
REQUEST:
GET /ratelimit-quotas/v1.0/multi1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:11 DEBUG: Sending GET request to http://localhost:8080/ratelimit-quotas/v1.0/multi1
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quotas/v1.0/multi1: status=200
2026/02/09 14:07:11 DEBUG: Request 5/5 completed, last response status: 200
2026/02/09 14:07:11 DEBUG: All 5 requests completed, final response status: 200
    [32mWhen[0m [32mI send 5 GET requests to "http://localhost:8080/ratelimit-quotas/v1.0/multi1"[0m           [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-quotas/v1.0/multi1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:11 DEBUG: Sending GET request to http://localhost:8080/ratelimit-quotas/v1.0/multi1
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quotas/v1.0/multi1: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-quotas/v1.0/multi1"[0m            [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:11 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-quotas/v1.0/multi2
REQUEST:
GET /ratelimit-quotas/v1.0/multi2 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:11 DEBUG: Sending GET request to http://localhost:8080/ratelimit-quotas/v1.0/multi2
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quotas/v1.0/multi2: status=200
2026/02/09 14:07:11 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-quotas/v1.0/multi2 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:11 DEBUG: Sending GET request to http://localhost:8080/ratelimit-quotas/v1.0/multi2
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quotas/v1.0/multi2: status=200
2026/02/09 14:07:11 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-quotas/v1.0/multi2 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:11 DEBUG: Sending GET request to http://localhost:8080/ratelimit-quotas/v1.0/multi2
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quotas/v1.0/multi2: status=200
2026/02/09 14:07:11 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:11 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-quotas/v1.0/multi2"[0m           [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-quotas/v1.0/multi2 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:11 DEBUG: Sending GET request to http://localhost:8080/ratelimit-quotas/v1.0/multi2
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quotas/v1.0/multi2: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-quotas/v1.0/multi2"[0m            [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:11 Scenario passed: Multi-dimensional rate limiting with quotas
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Per-quota_cost_extraction_with_multiplier
2026/02/09 14:07:11 Starting scenario: Per-quota cost extraction with multiplier

  [1;37mScenario:[0m Per-quota cost extraction with multiplier                                                   [1;30m# features/ratelimit.feature:589[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                    [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 840
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-quota-cost-api
spec:
  displayName: RateLimit Quota Cost API
  version: v1.0
  context: /ratelimit-quota-cost/$version
  upstream:
    main:
      url: http://echo-backend:80
  operations:
    - method: GET
      path: /get
    - method: POST
      path: /anything
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: token-limit
                limits:
                  - limit: 100
                    duration: "1h"
                costExtraction:
                  enabled: true
                  sources:
                    - type: response_body
                      jsonPath: "$.json.tokens"
                      multiplier: 2.0
                  default: 1
2026/02/09 14:07:11 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                               [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-quota-cost-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Quota Cost API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-quota-cost/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://echo-backend:80[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /get[0m
      [36m    - method: POST[0m
      [36m      path: /anything[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: token-limit[0m
      [36m                limits:[0m
      [36m                  - limit: 100[0m
      [36m                    duration: "1h"[0m
      [36m                costExtraction:[0m
      [36m                  enabled: true[0m
      [36m                  sources:[0m
      [36m                    - type: response_body[0m
      [36m                      jsonPath: "$.json.tokens"[0m
      [36m                      multiplier: 2.0[0m
      [36m                  default: 1[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                              [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-quota-cost/v1.0/get" to be ready[0m       [1;30m# <autogenerated>:1 -> *HealthSteps[0m
REQUEST:
POST /ratelimit-quota-cost/v1.0/anything HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 14
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

{"tokens": 25}
2026/02/09 14:07:11 DEBUG: Sending POST request to http://localhost:8080/ratelimit-quota-cost/v1.0/anything
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quota-cost/v1.0/anything: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-quota-cost/v1.0/anything" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"tokens": 25}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                         [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should be "50"[0m                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-quota-cost/v1.0/anything HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 14
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

{"tokens": 25}
2026/02/09 14:07:11 DEBUG: Sending POST request to http://localhost:8080/ratelimit-quota-cost/v1.0/anything
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quota-cost/v1.0/anything: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-quota-cost/v1.0/anything" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"tokens": 25}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                         [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should be "0"[0m                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-quota-cost/v1.0/anything HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 14
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

{"tokens": 10}
2026/02/09 14:07:11 DEBUG: Sending POST request to http://localhost:8080/ratelimit-quota-cost/v1.0/anything
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:8080/ratelimit-quota-cost/v1.0/anything: status=429
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-quota-cost/v1.0/anything" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"tokens": 10}[0m
      [36m"""[0m
2026/02/09 14:07:11 Scenario passed: Per-quota cost extraction with multiplier
    [32mThen[0m [32mthe response status code should be 429[0m                                                         [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Header-based_key_extraction_for_per-user_rate_limiting
2026/02/09 14:07:11 Starting scenario: Header-based key extraction for per-user rate limiting

  [1;37mScenario:[0m Header-based key extraction for per-user rate limiting                                                           [1;30m# features/ratelimit.feature:654[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                                         [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 655
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-peruser-api
spec:
  displayName: RateLimit Per-User API
  version: v1.0
  context: /ratelimit-peruser/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /user
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: per-user-limit
                limits:
                  - limit: 3
                    duration: "1h"
                keyExtraction:
                  - type: header
                    key: X-User-ID
2026/02/09 14:07:11 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:11 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                                    [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-peruser-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Per-User API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-peruser/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /user[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: per-user-limit[0m
      [36m                limits:[0m
      [36m                  - limit: 3[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: header[0m
      [36m                    key: X-User-ID[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-peruser/v1.0/user" to be ready[0m                              [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:12 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-peruser/v1.0/user with header X-User-ID=user-A
REQUEST:
GET /ratelimit-peruser/v1.0/user HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-A
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-peruser/v1.0/user
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-peruser/v1.0/user: status=200
2026/02/09 14:07:12 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-peruser/v1.0/user HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-A
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-peruser/v1.0/user
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-peruser/v1.0/user: status=200
2026/02/09 14:07:12 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-peruser/v1.0/user HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-A
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-peruser/v1.0/user
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-peruser/v1.0/user: status=200
2026/02/09 14:07:12 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:12 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-peruser/v1.0/user" with header "X-User-ID" value "user-A"[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                              [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-peruser/v1.0/user HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-A
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-peruser/v1.0/user
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-peruser/v1.0/user: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-peruser/v1.0/user" with header "X-User-ID" value "user-A"[0m  [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                                              [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:12 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-peruser/v1.0/user with header X-User-ID=user-B
REQUEST:
GET /ratelimit-peruser/v1.0/user HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-B
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-peruser/v1.0/user
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-peruser/v1.0/user: status=200
2026/02/09 14:07:12 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-peruser/v1.0/user HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-B
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-peruser/v1.0/user
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-peruser/v1.0/user: status=200
2026/02/09 14:07:12 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-peruser/v1.0/user HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-B
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-peruser/v1.0/user
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-peruser/v1.0/user: status=200
2026/02/09 14:07:12 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:12 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-peruser/v1.0/user" with header "X-User-ID" value "user-B"[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                              [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-peruser/v1.0/user HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-B
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-peruser/v1.0/user
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-peruser/v1.0/user: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-peruser/v1.0/user" with header "X-User-ID" value "user-B"[0m  [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:12 Scenario passed: Header-based key extraction for per-user rate limiting
    [32mThen[0m [32mthe response status code should be 429[0m                                                                              [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Multiple_limits_per_quota_-_enforces_most_restrictive_limit
2026/02/09 14:07:12 Starting scenario: Multiple limits per quota - enforces most restrictive limit

  [1;37mScenario:[0m Multiple limits per quota - enforces most restrictive limit                               [1;30m# features/ratelimit.feature:704[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                  [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 747
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-multilimits-api
spec:
  displayName: RateLimit Multiple Limits API
  version: v1.0
  context: /ratelimit-multilimits/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: "request-quota"
                limits:
                  - limit: 10
                    duration: "1h"
                  - limit: 8
                    duration: "24h"
                keyExtraction:
                  - type: routename
2026/02/09 14:07:12 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                             [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-multilimits-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Multiple Limits API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-multilimits/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: "request-quota"[0m
      [36m                limits:[0m
      [36m                  - limit: 10[0m
      [36m                    duration: "1h"[0m
      [36m                  - limit: 8[0m
      [36m                    duration: "24h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: routename[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                            [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-multilimits/v1.0/health" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:12 DEBUG: Sending 8 GET requests to http://localhost:8080/ratelimit-multilimits/v1.0/resource
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:12 DEBUG: Request 1/8 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:12 DEBUG: Request 2/8 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:12 DEBUG: Request 3/8 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:12 DEBUG: Request 4/8 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:12 DEBUG: Request 5/8 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:12 DEBUG: Request 6/8 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:12 DEBUG: Request 7/8 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:12 DEBUG: Request 8/8 completed, last response status: 200
2026/02/09 14:07:12 DEBUG: All 8 requests completed, final response status: 200
    [32mWhen[0m [32mI send 8 GET requests to "http://localhost:8080/ratelimit-multilimits/v1.0/resource"[0m         [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:12 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-multilimits/v1.0/resource"[0m          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
PUT /apis/ratelimit-multilimits-api HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 751
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-multilimits-api
spec:
  displayName: RateLimit Multiple Limits API
  version: v1.0
  context: /ratelimit-multilimits/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: "request-quota"
                limits:
                  - limit: 12
                    duration: "1h"
                  - limit: 10000
                    duration: "24h"
                keyExtraction:
                  - type: routename
2026/02/09 14:07:12 DEBUG: Sending PUT request to http://localhost:9090/apis/ratelimit-multilimits-api
2026/02/09 14:07:12 DEBUG: Received response from http://localhost:9090/apis/ratelimit-multilimits-api: status=200
    [32mWhen[0m [32mI update the API "ratelimit-multilimits-api" with this configuration:[0m                        [1;30m# steps_api.go:69 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func4[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-multilimits-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Multiple Limits API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-multilimits/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: "request-quota"[0m
      [36m                limits:[0m
      [36m                  - limit: 12[0m
      [36m                    duration: "1h"[0m
      [36m                  - limit: 10000[0m
      [36m                    duration: "24h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: routename[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                            [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for 2 seconds[0m                                                                          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:15 DEBUG: Sending 12 GET requests to http://localhost:8080/ratelimit-multilimits/v1.0/resource
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:15 DEBUG: Request 1/12 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:15 DEBUG: Request 2/12 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:15 DEBUG: Request 3/12 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:15 DEBUG: Request 4/12 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:15 DEBUG: Request 5/12 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:15 DEBUG: Request 6/12 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:15 DEBUG: Request 7/12 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:15 DEBUG: Request 8/12 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:15 DEBUG: Request 9/12 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:15 DEBUG: Request 10/12 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:15 DEBUG: Request 11/12 completed, last response status: 200
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=200
2026/02/09 14:07:15 DEBUG: Request 12/12 completed, last response status: 200
2026/02/09 14:07:15 DEBUG: All 12 requests completed, final response status: 200
    [32mWhen[0m [32mI send 12 GET requests to "http://localhost:8080/ratelimit-multilimits/v1.0/resource"[0m        [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-multilimits/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:15 DEBUG: Sending GET request to http://localhost:8080/ratelimit-multilimits/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-multilimits/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-multilimits/v1.0/resource"[0m          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:15 Scenario passed: Multiple limits per quota - enforces most restrictive limit
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Cost_extraction_from_request_body
2026/02/09 14:07:15 Starting scenario: Cost extraction from request body

  [1;37mScenario:[0m Cost extraction from request body                                                                  [1;30m# features/ratelimit.feature:801[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                           [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 831
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-request-body-cost-api
spec:
  displayName: RateLimit Request Body Cost API
  version: v1.0
  context: /ratelimit-request-body-cost/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: POST
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: token-quota
                limits:
                  - limit: 100
                    duration: "1h"
                costExtraction:
                  enabled: true
                  sources:
                    - type: request_body
                      jsonPath: "$.tokens"
                  default: 1
2026/02/09 14:07:15 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                      [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-request-body-cost-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Request Body Cost API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-request-body-cost/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: POST[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: token-quota[0m
      [36m                limits:[0m
      [36m                  - limit: 100[0m
      [36m                    duration: "1h"[0m
      [36m                costExtraction:[0m
      [36m                  enabled: true[0m
      [36m                  sources:[0m
      [36m                    - type: request_body[0m
      [36m                      jsonPath: "$.tokens"[0m
      [36m                  default: 1[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-request-body-cost/v1.0/health" to be ready[0m    [1;30m# <autogenerated>:1 -> *HealthSteps[0m
REQUEST:
POST /ratelimit-request-body-cost/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 14
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

{"tokens": 40}
2026/02/09 14:07:15 DEBUG: Sending POST request to http://localhost:8080/ratelimit-request-body-cost/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-request-body-cost/v1.0/resource: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-request-body-cost/v1.0/resource" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"tokens": 40}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should be "60"[0m                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-request-body-cost/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 14
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

{"tokens": 40}
2026/02/09 14:07:15 DEBUG: Sending POST request to http://localhost:8080/ratelimit-request-body-cost/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-request-body-cost/v1.0/resource: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-request-body-cost/v1.0/resource" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"tokens": 40}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should be "20"[0m                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-request-body-cost/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 14
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

{"tokens": 30}
2026/02/09 14:07:15 DEBUG: Sending POST request to http://localhost:8080/ratelimit-request-body-cost/v1.0/resource
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:8080/ratelimit-request-body-cost/v1.0/resource: status=429
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-request-body-cost/v1.0/resource" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"tokens": 30}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:15 Scenario passed: Cost extraction from request body
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                                 [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Multiple_quotas_with_prompt_and_completion_token_cost_extraction
2026/02/09 14:07:15 Starting scenario: Multiple quotas with prompt and completion token cost extraction

  [1;37mScenario:[0m Multiple quotas with prompt and completion token cost extraction                                                                      [1;30m# features/ratelimit.feature:867[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                                                              [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 1461
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-prompt-tokens-api
spec:
  displayName: RateLimit Prompt Tokens API
  version: v1.0
  context: /ratelimit-prompt-tokens/$version
  upstream:
    main:
      url: http://echo-backend:80
  operations:
    - method: GET
      path: /get
    - method: POST
      path: /anything
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: "prompt-tokens"
                limits:
                  - limit: 500
                    duration: "1h"
                keyExtraction:
                  - type: header
                    key: X-User-ID
                costExtraction:
                  enabled: true
                  sources:
                    - type: response_body
                      jsonPath: "$.json.usage.prompt_tokens"
                      multiplier: 1.0
                  default: 0
              - name: "completion-tokens"
                limits:
                  - limit: 200
                    duration: "1h"
                keyExtraction:
                  - type: header
                    key: X-User-ID
                costExtraction:
                  enabled: true
                  sources:
                    - type: response_body
                      jsonPath: "$.json.usage.completion_tokens"
                      multiplier: 1.0
                  default: 0
2026/02/09 14:07:15 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:15 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                                                         [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-prompt-tokens-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Prompt Tokens API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-prompt-tokens/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://echo-backend:80[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /get[0m
      [36m    - method: POST[0m
      [36m      path: /anything[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: "prompt-tokens"[0m
      [36m                limits:[0m
      [36m                  - limit: 500[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: header[0m
      [36m                    key: X-User-ID[0m
      [36m                costExtraction:[0m
      [36m                  enabled: true[0m
      [36m                  sources:[0m
      [36m                    - type: response_body[0m
      [36m                      jsonPath: "$.json.usage.prompt_tokens"[0m
      [36m                      multiplier: 1.0[0m
      [36m                  default: 0[0m
      [36m              - name: "completion-tokens"[0m
      [36m                limits:[0m
      [36m                  - limit: 200[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: header[0m
      [36m                    key: X-User-ID[0m
      [36m                costExtraction:[0m
      [36m                  enabled: true[0m
      [36m                  sources:[0m
      [36m                    - type: response_body[0m
      [36m                      jsonPath: "$.json.usage.completion_tokens"[0m
      [36m                      multiplier: 1.0[0m
      [36m                  default: 0[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-prompt-tokens/v1.0/get" to be ready[0m                                              [1;30m# <autogenerated>:1 -> *HealthSteps[0m
REQUEST:
POST /ratelimit-prompt-tokens/v1.0/anything HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 58
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-A
Accept-Encoding: gzip

{"usage": {"prompt_tokens": 50, "completion_tokens": 100}}
2026/02/09 14:07:16 DEBUG: Sending POST request to http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything
2026/02/09 14:07:16 DEBUG: Received response from http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything" with header "X-User-ID" value "user-A" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"usage": {"prompt_tokens": 50, "completion_tokens": 100}}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-prompt-tokens/v1.0/anything HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 58
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-A
Accept-Encoding: gzip

{"usage": {"prompt_tokens": 50, "completion_tokens": 100}}
2026/02/09 14:07:16 DEBUG: Sending POST request to http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything
2026/02/09 14:07:16 DEBUG: Received response from http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything" with header "X-User-ID" value "user-A" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"usage": {"prompt_tokens": 50, "completion_tokens": 100}}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-prompt-tokens/v1.0/anything HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 57
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-A
Accept-Encoding: gzip

{"usage": {"prompt_tokens": 50, "completion_tokens": 50}}
2026/02/09 14:07:16 DEBUG: Sending POST request to http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything
2026/02/09 14:07:16 DEBUG: Received response from http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything: status=429
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything" with header "X-User-ID" value "user-A" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"usage": {"prompt_tokens": 50, "completion_tokens": 50}}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                                                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-prompt-tokens/v1.0/anything HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 58
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-B
Accept-Encoding: gzip

{"usage": {"prompt_tokens": 250, "completion_tokens": 10}}
2026/02/09 14:07:16 DEBUG: Sending POST request to http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything
2026/02/09 14:07:16 DEBUG: Received response from http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything" with header "X-User-ID" value "user-B" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"usage": {"prompt_tokens": 250, "completion_tokens": 10}}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-prompt-tokens/v1.0/anything HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 58
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-B
Accept-Encoding: gzip

{"usage": {"prompt_tokens": 250, "completion_tokens": 10}}
2026/02/09 14:07:16 DEBUG: Sending POST request to http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything
2026/02/09 14:07:16 DEBUG: Received response from http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything" with header "X-User-ID" value "user-B" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"usage": {"prompt_tokens": 250, "completion_tokens": 10}}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-prompt-tokens/v1.0/anything HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 57
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-B
Accept-Encoding: gzip

{"usage": {"prompt_tokens": 50, "completion_tokens": 10}}
2026/02/09 14:07:16 DEBUG: Sending POST request to http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything
2026/02/09 14:07:16 DEBUG: Received response from http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything: status=429
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-prompt-tokens/v1.0/anything" with header "X-User-ID" value "user-B" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"usage": {"prompt_tokens": 50, "completion_tokens": 10}}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                                                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:16 Scenario passed: Multiple quotas with prompt and completion token cost extraction
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/IP-based_rate_limiting_using_X-Forwarded-For_header
2026/02/09 14:07:16 Starting scenario: IP-based rate limiting using X-Forwarded-For header

  [1;37mScenario:[0m IP-based rate limiting using X-Forwarded-For header                                                                                [1;30m# features/ratelimit.feature:980[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                                                           [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 620
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-ip-based-api
spec:
  displayName: RateLimit IP Based API
  version: v1.0
  context: /ratelimit-ip-based/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: per-ip-limit
                limits:
                  - limit: 3
                    duration: "1h"
                keyExtraction:
                  - type: ip
2026/02/09 14:07:16 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:16 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                                                      [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-ip-based-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit IP Based API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-ip-based/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: per-ip-limit[0m
      [36m                limits:[0m
      [36m                  - limit: 3[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: ip[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-ip-based/v1.0/resource" to be ready[0m                                           [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:17 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-ip-based/v1.0/resource with header X-Forwarded-For=192.168.1.100
REQUEST:
GET /ratelimit-ip-based/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Forwarded-For: 192.168.1.100
Accept-Encoding: gzip


2026/02/09 14:07:17 DEBUG: Sending GET request to http://localhost:8080/ratelimit-ip-based/v1.0/resource
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:8080/ratelimit-ip-based/v1.0/resource: status=200
2026/02/09 14:07:17 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-ip-based/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Forwarded-For: 192.168.1.100
Accept-Encoding: gzip


2026/02/09 14:07:17 DEBUG: Sending GET request to http://localhost:8080/ratelimit-ip-based/v1.0/resource
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:8080/ratelimit-ip-based/v1.0/resource: status=200
2026/02/09 14:07:17 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-ip-based/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Forwarded-For: 192.168.1.100
Accept-Encoding: gzip


2026/02/09 14:07:17 DEBUG: Sending GET request to http://localhost:8080/ratelimit-ip-based/v1.0/resource
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:8080/ratelimit-ip-based/v1.0/resource: status=200
2026/02/09 14:07:17 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:17 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-ip-based/v1.0/resource" with header "X-Forwarded-For" value "192.168.1.100"[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-ip-based/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Forwarded-For: 192.168.1.100
Accept-Encoding: gzip


2026/02/09 14:07:17 DEBUG: Sending GET request to http://localhost:8080/ratelimit-ip-based/v1.0/resource
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:8080/ratelimit-ip-based/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-ip-based/v1.0/resource" with header "X-Forwarded-For" value "192.168.1.100"[0m  [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:17 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-ip-based/v1.0/resource with header X-Forwarded-For=192.168.1.200
REQUEST:
GET /ratelimit-ip-based/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Forwarded-For: 192.168.1.200
Accept-Encoding: gzip


2026/02/09 14:07:17 DEBUG: Sending GET request to http://localhost:8080/ratelimit-ip-based/v1.0/resource
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:8080/ratelimit-ip-based/v1.0/resource: status=200
2026/02/09 14:07:17 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-ip-based/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Forwarded-For: 192.168.1.200
Accept-Encoding: gzip


2026/02/09 14:07:17 DEBUG: Sending GET request to http://localhost:8080/ratelimit-ip-based/v1.0/resource
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:8080/ratelimit-ip-based/v1.0/resource: status=200
2026/02/09 14:07:17 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-ip-based/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Forwarded-For: 192.168.1.200
Accept-Encoding: gzip


2026/02/09 14:07:17 DEBUG: Sending GET request to http://localhost:8080/ratelimit-ip-based/v1.0/resource
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:8080/ratelimit-ip-based/v1.0/resource: status=200
2026/02/09 14:07:17 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:17 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-ip-based/v1.0/resource" with header "X-Forwarded-For" value "192.168.1.200"[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-ip-based/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Forwarded-For: 192.168.1.200
Accept-Encoding: gzip


2026/02/09 14:07:17 DEBUG: Sending GET request to http://localhost:8080/ratelimit-ip-based/v1.0/resource
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:8080/ratelimit-ip-based/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-ip-based/v1.0/resource" with header "X-Forwarded-For" value "192.168.1.200"[0m  [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:17 Scenario passed: IP-based rate limiting using X-Forwarded-For header
    [32mThen[0m [32mthe response status code should be 429[0m                                                                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Cost_extraction_from_request_header
2026/02/09 14:07:17 Starting scenario: Cost extraction from request header

  [1;37mScenario:[0m Cost extraction from request header                                                                                                        [1;30m# features/ratelimit.feature:1029[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                                                                   [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 836
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-request-header-cost-api
spec:
  displayName: RateLimit Request Header Cost API
  version: v1.0
  context: /ratelimit-request-header-cost/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: POST
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: token-quota
                limits:
                  - limit: 100
                    duration: "1h"
                costExtraction:
                  enabled: true
                  sources:
                    - type: request_header
                      key: X-Token-Cost
                  default: 1
2026/02/09 14:07:17 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                                                              [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-request-header-cost-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Request Header Cost API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-request-header-cost/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: POST[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: token-quota[0m
      [36m                limits:[0m
      [36m                  - limit: 100[0m
      [36m                    duration: "1h"[0m
      [36m                costExtraction:[0m
      [36m                  enabled: true[0m
      [36m                  sources:[0m
      [36m                    - type: request_header[0m
      [36m                      key: X-Token-Cost[0m
      [36m                  default: 1[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-request-header-cost/v1.0/health" to be ready[0m                                          [1;30m# <autogenerated>:1 -> *HealthSteps[0m
REQUEST:
POST /ratelimit-request-header-cost/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 2
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Token-Cost: 40
Accept-Encoding: gzip

{}
2026/02/09 14:07:17 DEBUG: Sending POST request to http://localhost:8080/ratelimit-request-header-cost/v1.0/resource
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:8080/ratelimit-request-header-cost/v1.0/resource: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-request-header-cost/v1.0/resource" with header "X-Token-Cost" value "40" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should be "60"[0m                                                                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-request-header-cost/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 2
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Token-Cost: 40
Accept-Encoding: gzip

{}
2026/02/09 14:07:17 DEBUG: Sending POST request to http://localhost:8080/ratelimit-request-header-cost/v1.0/resource
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:8080/ratelimit-request-header-cost/v1.0/resource: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-request-header-cost/v1.0/resource" with header "X-Token-Cost" value "40" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should be "20"[0m                                                                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-request-header-cost/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 2
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Token-Cost: 30
Accept-Encoding: gzip

{}
2026/02/09 14:07:17 DEBUG: Sending POST request to http://localhost:8080/ratelimit-request-header-cost/v1.0/resource
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:8080/ratelimit-request-header-cost/v1.0/resource: status=429
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-request-header-cost/v1.0/resource" with header "X-Token-Cost" value "30" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                                                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:17 Scenario passed: Cost extraction from request header
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                                                                         [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Composite_key_extraction_with_multiple_components
2026/02/09 14:07:17 Starting scenario: Composite key extraction with multiple components

  [1;37mScenario:[0m Composite key extraction with multiple components                                                                          [1;30m# features/ratelimit.feature:1094[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                                                   [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 712
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-composite-key-api
spec:
  displayName: RateLimit Composite Key API
  version: v1.0
  context: /ratelimit-composite-key/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: per-user-per-api
                limits:
                  - limit: 3
                    duration: "1h"
                keyExtraction:
                  - type: apiname
                  - type: header
                    key: X-User-ID
2026/02/09 14:07:17 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:17 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                                              [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-composite-key-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Composite Key API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-composite-key/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: per-user-per-api[0m
      [36m                limits:[0m
      [36m                  - limit: 3[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: apiname[0m
      [36m                  - type: header[0m
      [36m                    key: X-User-ID[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-composite-key/v1.0/resource" to be ready[0m                              [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:18 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-composite-key/v1.0/resource with header X-User-ID=user-A
REQUEST:
GET /ratelimit-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-A
Accept-Encoding: gzip


2026/02/09 14:07:18 DEBUG: Sending GET request to http://localhost:8080/ratelimit-composite-key/v1.0/resource
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:8080/ratelimit-composite-key/v1.0/resource: status=200
2026/02/09 14:07:18 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-A
Accept-Encoding: gzip


2026/02/09 14:07:18 DEBUG: Sending GET request to http://localhost:8080/ratelimit-composite-key/v1.0/resource
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:8080/ratelimit-composite-key/v1.0/resource: status=200
2026/02/09 14:07:18 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-A
Accept-Encoding: gzip


2026/02/09 14:07:18 DEBUG: Sending GET request to http://localhost:8080/ratelimit-composite-key/v1.0/resource
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:8080/ratelimit-composite-key/v1.0/resource: status=200
2026/02/09 14:07:18 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:18 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-composite-key/v1.0/resource" with header "X-User-ID" value "user-A"[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-A
Accept-Encoding: gzip


2026/02/09 14:07:18 DEBUG: Sending GET request to http://localhost:8080/ratelimit-composite-key/v1.0/resource
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:8080/ratelimit-composite-key/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-composite-key/v1.0/resource" with header "X-User-ID" value "user-A"[0m  [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:18 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-composite-key/v1.0/resource with header X-User-ID=user-B
REQUEST:
GET /ratelimit-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-B
Accept-Encoding: gzip


2026/02/09 14:07:18 DEBUG: Sending GET request to http://localhost:8080/ratelimit-composite-key/v1.0/resource
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:8080/ratelimit-composite-key/v1.0/resource: status=200
2026/02/09 14:07:18 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-B
Accept-Encoding: gzip


2026/02/09 14:07:18 DEBUG: Sending GET request to http://localhost:8080/ratelimit-composite-key/v1.0/resource
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:8080/ratelimit-composite-key/v1.0/resource: status=200
2026/02/09 14:07:18 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-B
Accept-Encoding: gzip


2026/02/09 14:07:18 DEBUG: Sending GET request to http://localhost:8080/ratelimit-composite-key/v1.0/resource
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:8080/ratelimit-composite-key/v1.0/resource: status=200
2026/02/09 14:07:18 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:18 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-composite-key/v1.0/resource" with header "X-User-ID" value "user-B"[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: user-B
Accept-Encoding: gzip


2026/02/09 14:07:18 DEBUG: Sending GET request to http://localhost:8080/ratelimit-composite-key/v1.0/resource
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:8080/ratelimit-composite-key/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-composite-key/v1.0/resource" with header "X-User-ID" value "user-B"[0m  [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:18 Scenario passed: Composite key extraction with multiple components
    [32mThen[0m [32mthe response status code should be 429[0m                                                                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Default_cost_fallback_when_extraction_fails
2026/02/09 14:07:18 Starting scenario: Default cost fallback when extraction fails

  [1;37mScenario:[0m Default cost fallback when extraction fails                                                   [1;30m# features/ratelimit.feature:1145[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                      [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 826
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-default-cost-api
spec:
  displayName: RateLimit Default Cost API
  version: v1.0
  context: /ratelimit-default-cost/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: POST
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: token-quota
                limits:
                  - limit: 10
                    duration: "1h"
                costExtraction:
                  enabled: true
                  sources:
                    - type: request_body
                      jsonPath: "$.nonexistent_field"
                  default: 5
2026/02/09 14:07:18 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                 [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-default-cost-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Default Cost API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-default-cost/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: POST[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: token-quota[0m
      [36m                limits:[0m
      [36m                  - limit: 10[0m
      [36m                    duration: "1h"[0m
      [36m                costExtraction:[0m
      [36m                  enabled: true[0m
      [36m                  sources:[0m
      [36m                    - type: request_body[0m
      [36m                      jsonPath: "$.nonexistent_field"[0m
      [36m                  default: 5[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-default-cost/v1.0/health" to be ready[0m    [1;30m# <autogenerated>:1 -> *HealthSteps[0m
REQUEST:
POST /ratelimit-default-cost/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 25
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

{"some_other_field": 100}
2026/02/09 14:07:18 DEBUG: Sending POST request to http://localhost:8080/ratelimit-default-cost/v1.0/resource
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:8080/ratelimit-default-cost/v1.0/resource: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-default-cost/v1.0/resource" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"some_other_field": 100}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                           [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should be "5"[0m                                         [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-default-cost/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 22
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

{"another_field": 200}
2026/02/09 14:07:18 DEBUG: Sending POST request to http://localhost:8080/ratelimit-default-cost/v1.0/resource
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:8080/ratelimit-default-cost/v1.0/resource: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-default-cost/v1.0/resource" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"another_field": 200}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                           [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should be "0"[0m                                         [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-default-cost/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 16
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

{"data": "test"}
2026/02/09 14:07:18 DEBUG: Sending POST request to http://localhost:8080/ratelimit-default-cost/v1.0/resource
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:8080/ratelimit-default-cost/v1.0/resource: status=429
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-default-cost/v1.0/resource" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{"data": "test"}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                           [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:18 Scenario passed: Default cost fallback when extraction fails
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                            [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Different_APIs_with_apiname_key_extraction_have_isolated_quotas
2026/02/09 14:07:18 Starting scenario: Different APIs with apiname key extraction have isolated quotas

  [1;37mScenario:[0m Different APIs with apiname key extraction have isolated quotas                                   [1;30m# features/ratelimit.feature:1211[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                          [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 693
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-apiname-isolation-api-a
spec:
  displayName: RateLimit ApiName Isolation API A
  version: v1.0
  context: /ratelimit-apiname-isolation-a/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: api-quota
                limits:
                  - limit: 5
                    duration: "1h"
                keyExtraction:
                  - type: apiname
2026/02/09 14:07:18 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:18 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                     [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-apiname-isolation-api-a[0m
      [36mspec:[0m
      [36m  displayName: RateLimit ApiName Isolation API A[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-apiname-isolation-a/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: api-quota[0m
      [36m                limits:[0m
      [36m                  - limit: 5[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: apiname[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/health" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 693
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-apiname-isolation-api-b
spec:
  displayName: RateLimit ApiName Isolation API B
  version: v1.0
  context: /ratelimit-apiname-isolation-b/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: api-quota
                limits:
                  - limit: 5
                    duration: "1h"
                keyExtraction:
                  - type: apiname
2026/02/09 14:07:19 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                     [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-apiname-isolation-api-b[0m
      [36mspec:[0m
      [36m  displayName: RateLimit ApiName Isolation API B[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-apiname-isolation-b/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: api-quota[0m
      [36m                limits:[0m
      [36m                  - limit: 5[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: apiname[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/health" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:19 DEBUG: Sending 5 GET requests to http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource
REQUEST:
GET /ratelimit-apiname-isolation-a/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource: status=200
2026/02/09 14:07:19 DEBUG: Request 1/5 completed, last response status: 200
REQUEST:
GET /ratelimit-apiname-isolation-a/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource: status=200
2026/02/09 14:07:19 DEBUG: Request 2/5 completed, last response status: 200
REQUEST:
GET /ratelimit-apiname-isolation-a/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource: status=200
2026/02/09 14:07:19 DEBUG: Request 3/5 completed, last response status: 200
REQUEST:
GET /ratelimit-apiname-isolation-a/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource: status=200
2026/02/09 14:07:19 DEBUG: Request 4/5 completed, last response status: 200
REQUEST:
GET /ratelimit-apiname-isolation-a/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource: status=200
2026/02/09 14:07:19 DEBUG: Request 5/5 completed, last response status: 200
2026/02/09 14:07:19 DEBUG: All 5 requests completed, final response status: 200
    [32mWhen[0m [32mI send 5 GET requests to "http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource"[0m         [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                               [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-apiname-isolation-a/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource"[0m          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                               [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:19 DEBUG: Sending 5 GET requests to http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource
REQUEST:
GET /ratelimit-apiname-isolation-b/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource: status=200
2026/02/09 14:07:19 DEBUG: Request 1/5 completed, last response status: 200
REQUEST:
GET /ratelimit-apiname-isolation-b/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource: status=200
2026/02/09 14:07:19 DEBUG: Request 2/5 completed, last response status: 200
REQUEST:
GET /ratelimit-apiname-isolation-b/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource: status=200
2026/02/09 14:07:19 DEBUG: Request 3/5 completed, last response status: 200
REQUEST:
GET /ratelimit-apiname-isolation-b/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource: status=200
2026/02/09 14:07:19 DEBUG: Request 4/5 completed, last response status: 200
REQUEST:
GET /ratelimit-apiname-isolation-b/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource: status=200
2026/02/09 14:07:19 DEBUG: Request 5/5 completed, last response status: 200
2026/02/09 14:07:19 DEBUG: All 5 requests completed, final response status: 200
    [32mWhen[0m [32mI send 5 GET requests to "http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource"[0m         [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                               [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-apiname-isolation-b/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-apiname-isolation-b/v1.0/resource"[0m          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                               [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-apiname-isolation-a/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:19 DEBUG: Sending GET request to http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-apiname-isolation-a/v1.0/resource"[0m          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:19 Scenario passed: Different APIs with apiname key extraction have isolated quotas
    [32mThen[0m [32mthe response status code should be 429[0m                                                               [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Resource_grouping_using_constant_key_extraction
2026/02/09 14:07:19 Starting scenario: Resource grouping using constant key extraction

  [1;37mScenario:[0m Resource grouping using constant key extraction                                        [1;30m# features/ratelimit.feature:1308[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                               [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 1457
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-constant-key-api
spec:
  displayName: RateLimit Constant Key API
  version: v1.0
  context: /ratelimit-constant/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /group-a-1
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - limits:
                  - limit: 5
                    duration: "1h"
                keyExtraction:
                  - type: apiname
                  - type: constant
                    key: "group-A"
    - method: GET
      path: /group-a-2
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - limits:
                  - limit: 5
                    duration: "1h"
                keyExtraction:
                  - type: apiname
                  - type: constant
                    key: "group-A"
    - method: GET
      path: /group-b-1
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - limits:
                  - limit: 5
                    duration: "1h"
                keyExtraction:
                  - type: apiname
                  - type: constant
                    key: "group-B"
2026/02/09 14:07:19 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:19 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                          [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-constant-key-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit Constant Key API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-constant/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /group-a-1[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - limits:[0m
      [36m                  - limit: 5[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: apiname[0m
      [36m                  - type: constant[0m
      [36m                    key: "group-A"[0m
      [36m    - method: GET[0m
      [36m      path: /group-a-2[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - limits:[0m
      [36m                  - limit: 5[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: apiname[0m
      [36m                  - type: constant[0m
      [36m                    key: "group-A"[0m
      [36m    - method: GET[0m
      [36m      path: /group-b-1[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - limits:[0m
      [36m                  - limit: 5[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: apiname[0m
      [36m                  - type: constant[0m
      [36m                    key: "group-B"[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                         [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-constant/v1.0/health" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:20 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-constant/v1.0/group-a-1
REQUEST:
GET /ratelimit-constant/v1.0/group-a-1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-a-1
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-a-1: status=200
2026/02/09 14:07:20 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-constant/v1.0/group-a-1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-a-1
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-a-1: status=200
2026/02/09 14:07:20 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-constant/v1.0/group-a-1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-a-1
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-a-1: status=200
2026/02/09 14:07:20 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:20 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-constant/v1.0/group-a-1"[0m        [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:20 DEBUG: Sending 2 GET requests to http://localhost:8080/ratelimit-constant/v1.0/group-a-2
REQUEST:
GET /ratelimit-constant/v1.0/group-a-2 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-a-2
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-a-2: status=200
2026/02/09 14:07:20 DEBUG: Request 1/2 completed, last response status: 200
REQUEST:
GET /ratelimit-constant/v1.0/group-a-2 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-a-2
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-a-2: status=200
2026/02/09 14:07:20 DEBUG: Request 2/2 completed, last response status: 200
2026/02/09 14:07:20 DEBUG: All 2 requests completed, final response status: 200
    [32mWhen[0m [32mI send 2 GET requests to "http://localhost:8080/ratelimit-constant/v1.0/group-a-2"[0m        [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-constant/v1.0/group-a-1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-a-1
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-a-1: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-constant/v1.0/group-a-1"[0m         [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                     [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-constant/v1.0/group-a-2 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-a-2
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-a-2: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-constant/v1.0/group-a-2"[0m         [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:20 DEBUG: Sending 5 GET requests to http://localhost:8080/ratelimit-constant/v1.0/group-b-1
REQUEST:
GET /ratelimit-constant/v1.0/group-b-1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-b-1
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-b-1: status=200
2026/02/09 14:07:20 DEBUG: Request 1/5 completed, last response status: 200
REQUEST:
GET /ratelimit-constant/v1.0/group-b-1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-b-1
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-b-1: status=200
2026/02/09 14:07:20 DEBUG: Request 2/5 completed, last response status: 200
REQUEST:
GET /ratelimit-constant/v1.0/group-b-1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-b-1
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-b-1: status=200
2026/02/09 14:07:20 DEBUG: Request 3/5 completed, last response status: 200
REQUEST:
GET /ratelimit-constant/v1.0/group-b-1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-b-1
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-b-1: status=200
2026/02/09 14:07:20 DEBUG: Request 4/5 completed, last response status: 200
REQUEST:
GET /ratelimit-constant/v1.0/group-b-1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-b-1
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-b-1: status=200
2026/02/09 14:07:20 DEBUG: Request 5/5 completed, last response status: 200
2026/02/09 14:07:20 DEBUG: All 5 requests completed, final response status: 200
    [32mWhen[0m [32mI send 5 GET requests to "http://localhost:8080/ratelimit-constant/v1.0/group-b-1"[0m        [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-constant/v1.0/group-b-1 HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-constant/v1.0/group-b-1
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-constant/v1.0/group-b-1: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-constant/v1.0/group-b-1"[0m         [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:20 Scenario passed: Resource grouping using constant key extraction
    [32mThen[0m [32mthe response status code should be 429[0m                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/CEL_expression_based_key_extraction_for_per-user_rate_limiting
2026/02/09 14:07:20 Starting scenario: CEL expression based key extraction for per-user rate limiting

  [1;37mScenario:[0m CEL expression based key extraction for per-user rate limiting                                                           [1;30m# features/ratelimit.feature:1398[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                                                 [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 684
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-cel-key-api
spec:
  displayName: RateLimit CEL Key API
  version: v1.0
  context: /ratelimit-cel-key/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: per-user-cel
                limits:
                  - limit: 3
                    duration: "1h"
                keyExtraction:
                  - type: cel
                    expression: 'request.Headers["x-user-id"][0]'
2026/02/09 14:07:20 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                                            [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-cel-key-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit CEL Key API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-cel-key/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: per-user-cel[0m
      [36m                limits:[0m
      [36m                  - limit: 3[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: cel[0m
      [36m                    expression: 'request.Headers["x-user-id"][0]'[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                                           [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-cel-key/v1.0/resource" to be ready[0m                                  [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:20 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-cel-key/v1.0/resource with header X-User-ID=cel-user-A
REQUEST:
GET /ratelimit-cel-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: cel-user-A
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-key/v1.0/resource
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-cel-key/v1.0/resource: status=200
2026/02/09 14:07:20 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-cel-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: cel-user-A
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-key/v1.0/resource
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-cel-key/v1.0/resource: status=200
2026/02/09 14:07:20 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-cel-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: cel-user-A
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-key/v1.0/resource
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-cel-key/v1.0/resource: status=200
2026/02/09 14:07:20 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:20 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-cel-key/v1.0/resource" with header "X-User-ID" value "cel-user-A"[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-cel-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: cel-user-A
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-key/v1.0/resource
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-cel-key/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-cel-key/v1.0/resource" with header "X-User-ID" value "cel-user-A"[0m  [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:20 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-cel-key/v1.0/resource with header X-User-ID=cel-user-B
REQUEST:
GET /ratelimit-cel-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: cel-user-B
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-key/v1.0/resource
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-cel-key/v1.0/resource: status=200
2026/02/09 14:07:20 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-cel-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: cel-user-B
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-key/v1.0/resource
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-cel-key/v1.0/resource: status=200
2026/02/09 14:07:20 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-cel-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: cel-user-B
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-key/v1.0/resource
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-cel-key/v1.0/resource: status=200
2026/02/09 14:07:20 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:20 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-cel-key/v1.0/resource" with header "X-User-ID" value "cel-user-B"[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-cel-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: cel-user-B
Accept-Encoding: gzip


2026/02/09 14:07:20 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-key/v1.0/resource
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:8080/ratelimit-cel-key/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-cel-key/v1.0/resource" with header "X-User-ID" value "cel-user-B"[0m  [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:20 Scenario passed: CEL expression based key extraction for per-user rate limiting
    [32mThen[0m [32mthe response status code should be 429[0m                                                                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/CEL_expression_based_composite_key_extraction
2026/02/09 14:07:20 Starting scenario: CEL expression based composite key extraction

  [1;37mScenario:[0m CEL expression based composite key extraction                                                                                            [1;30m# features/ratelimit.feature:1448[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                                                                 [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 739
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-cel-composite-key-api
spec:
  displayName: RateLimit CEL Composite Key API
  version: v1.0
  context: /ratelimit-cel-composite-key/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: per-user-per-api-cel
                limits:
                  - limit: 3
                    duration: "1h"
                keyExtraction:
                  - type: cel
                    expression: 'api.Name + ":" + request.Headers["x-user-id"][0]'
2026/02/09 14:07:20 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:20 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                                                            [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-cel-composite-key-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit CEL Composite Key API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-cel-composite-key/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: per-user-per-api-cel[0m
      [36m                limits:[0m
      [36m                  - limit: 3[0m
      [36m                    duration: "1h"[0m
      [36m                keyExtraction:[0m
      [36m                  - type: cel[0m
      [36m                    expression: 'api.Name + ":" + request.Headers["x-user-id"][0]'[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                                                           [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource" to be ready[0m                                        [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:21 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource with header X-User-ID=composite-user-A
REQUEST:
GET /ratelimit-cel-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: composite-user-A
Accept-Encoding: gzip


2026/02/09 14:07:21 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource
2026/02/09 14:07:21 DEBUG: Received response from http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource: status=200
2026/02/09 14:07:21 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-cel-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: composite-user-A
Accept-Encoding: gzip


2026/02/09 14:07:21 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource
2026/02/09 14:07:21 DEBUG: Received response from http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource: status=200
2026/02/09 14:07:21 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-cel-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: composite-user-A
Accept-Encoding: gzip


2026/02/09 14:07:21 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource
2026/02/09 14:07:21 DEBUG: Received response from http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource: status=200
2026/02/09 14:07:21 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:21 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource" with header "X-User-ID" value "composite-user-A"[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /ratelimit-cel-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: composite-user-A
Accept-Encoding: gzip


2026/02/09 14:07:21 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource
2026/02/09 14:07:21 DEBUG: Received response from http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource: status=429
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource" with header "X-User-ID" value "composite-user-A"[0m  [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                                                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:21 DEBUG: Sending 3 GET requests to http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource with header X-User-ID=composite-user-B
REQUEST:
GET /ratelimit-cel-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: composite-user-B
Accept-Encoding: gzip


2026/02/09 14:07:21 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource
2026/02/09 14:07:21 DEBUG: Received response from http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource: status=200
2026/02/09 14:07:21 DEBUG: Request 1/3 completed, last response status: 200
REQUEST:
GET /ratelimit-cel-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: composite-user-B
Accept-Encoding: gzip


2026/02/09 14:07:21 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource
2026/02/09 14:07:21 DEBUG: Received response from http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource: status=200
2026/02/09 14:07:21 DEBUG: Request 2/3 completed, last response status: 200
REQUEST:
GET /ratelimit-cel-composite-key/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-User-Id: composite-user-B
Accept-Encoding: gzip


2026/02/09 14:07:21 DEBUG: Sending GET request to http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource
2026/02/09 14:07:21 DEBUG: Received response from http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource: status=200
2026/02/09 14:07:21 DEBUG: Request 3/3 completed, last response status: 200
2026/02/09 14:07:21 DEBUG: All 3 requests completed, final response status: 200
    [32mWhen[0m [32mI send 3 GET requests to "http://localhost:8080/ratelimit-cel-composite-key/v1.0/resource" with header "X-User-ID" value "composite-user-B"[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:21 Scenario passed: CEL expression based composite key extraction
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/CEL_expression_based_cost_extraction_from_request_header
2026/02/09 14:07:21 Starting scenario: CEL expression based cost extraction from request header

  [1;37mScenario:[0m CEL expression based cost extraction from request header                                                                        [1;30m# features/ratelimit.feature:1494[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                                                        [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 840
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: ratelimit-cel-cost-api
spec:
  displayName: RateLimit CEL Cost API
  version: v1.0
  context: /ratelimit-cel-cost/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: POST
      path: /resource
      policies:
        - name: advanced-ratelimit
          version: v0
          params:
            quotas:
              - name: token-quota-cel
                limits:
                  - limit: 100
                    duration: "1h"
                costExtraction:
                  enabled: true
                  sources:
                    - type: request_cel
                      expression: 'int(request.Headers["x-token-cost"][0])'
                  default: 1
2026/02/09 14:07:21 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:21 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                                                   [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: ratelimit-cel-cost-api[0m
      [36mspec:[0m
      [36m  displayName: RateLimit CEL Cost API[0m
      [36m  version: v1.0[0m
      [36m  context: /ratelimit-cel-cost/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: POST[0m
      [36m      path: /resource[0m
      [36m      policies:[0m
      [36m        - name: advanced-ratelimit[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            quotas:[0m
      [36m              - name: token-quota-cel[0m
      [36m                limits:[0m
      [36m                  - limit: 100[0m
      [36m                    duration: "1h"[0m
      [36m                costExtraction:[0m
      [36m                  enabled: true[0m
      [36m                  sources:[0m
      [36m                    - type: request_cel[0m
      [36m                      expression: 'int(request.Headers["x-token-cost"][0])'[0m
      [36m                  default: 1[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/ratelimit-cel-cost/v1.0/health" to be ready[0m                                          [1;30m# <autogenerated>:1 -> *HealthSteps[0m
REQUEST:
POST /ratelimit-cel-cost/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 2
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Token-Cost: 40
Accept-Encoding: gzip

{}
2026/02/09 14:07:21 DEBUG: Sending POST request to http://localhost:8080/ratelimit-cel-cost/v1.0/resource
2026/02/09 14:07:21 DEBUG: Received response from http://localhost:8080/ratelimit-cel-cost/v1.0/resource: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-cel-cost/v1.0/resource" with header "X-Token-Cost" value "40" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should be "60"[0m                                                                          [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-cel-cost/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 2
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Token-Cost: 40
Accept-Encoding: gzip

{}
2026/02/09 14:07:21 DEBUG: Sending POST request to http://localhost:8080/ratelimit-cel-cost/v1.0/resource
2026/02/09 14:07:21 DEBUG: Received response from http://localhost:8080/ratelimit-cel-cost/v1.0/resource: status=200
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-cel-cost/v1.0/resource" with header "X-Token-Cost" value "40" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mthe response header "X-RateLimit-Remaining" should be "20"[0m                                                                          [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
POST /ratelimit-cel-cost/v1.0/resource HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Content-Length: 2
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
X-Token-Cost: 30
Accept-Encoding: gzip

{}
2026/02/09 14:07:21 DEBUG: Sending POST request to http://localhost:8080/ratelimit-cel-cost/v1.0/resource
2026/02/09 14:07:21 DEBUG: Received response from http://localhost:8080/ratelimit-cel-cost/v1.0/resource: status=429
    [32mWhen[0m [32mI send a POST request to "http://localhost:8080/ratelimit-cel-cost/v1.0/resource" with header "X-Token-Cost" value "30" with body:[0m [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
      [36m"""[0m
      [36m{}[0m
      [36m"""[0m
    [32mThen[0m [32mthe response status code should be 429[0m                                                                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:21 Scenario passed: CEL expression based cost extraction from request header
    [32mAnd[0m [32mthe response body should contain "Rate limit exceeded"[0m                                                                              [1;30m# <autogenerated>:1 -> *AssertSteps[0m

[1;37mFeature:[0m JWT Authentication
  As an API developer
  I want to secure my APIs with JWT authentication
  So that only authorized requests with valid tokens can access my resources
=== RUN   TestFeatures/Request_with_valid_JWT_token_is_authorized
2026/02/09 14:07:21 Starting scenario: Request with valid JWT token is authorized

  [1;37mBackground:[0m
    [32mGiven[0m [32mthe gateway services are running[0m                                                               [1;30m# <autogenerated>:1 -> *HealthSteps[0m

  [1;37mScenario:[0m Request with valid JWT token is authorized                                                   [1;30m# features/jwt-auth.feature:28[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                     [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 481
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: jwt-auth-basic-api
spec:
  displayName: JWT Auth Basic API
  version: v1.0
  context: /jwt-auth-basic/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /protected
      policies:
        - name: jwt-auth
          version: v0
          params:
            issuers:
              - mock-jwks
2026/02/09 14:07:21 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:21 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: jwt-auth-basic-api[0m
      [36mspec:[0m
      [36m  displayName: JWT Auth Basic API[0m
      [36m  version: v1.0[0m
      [36m  context: /jwt-auth-basic/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /protected[0m
      [36m      policies:[0m
      [36m        - name: jwt-auth[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            issuers:[0m
      [36m              - mock-jwks[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                               [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/jwt-auth-basic/v1.0/health" to be ready[0m           [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:22 DEBUG: Fetching JWT token from http://localhost:8082/token?issuer=http%3A%2F%2Fmock-jwks%3A8080%2Ftoken
2026/02/09 14:07:22 DEBUG: Obtained JWT token (length: 555)
    [32mWhen[0m [32mI get a JWT token from the mock JWKS server with issuer "http://mock-jwks:8080/token"[0m           [1;30m# <autogenerated>:1 -> *JWTSteps[0m
REQUEST:
GET /jwt-auth-basic/v1.0/protected HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6InRlc3Qta2V5LWlkIiwidHlwIjoiSldUIn0.eyJhdWQiOiJ0ZXN0LWF1ZGllbmNlIiwiZXhwIjoxNzcwNjI5ODQyLCJpc3MiOiJodHRwOi8vbW9jay1qd2tzOjgwODAvdG9rZW4iLCJuYmYiOjE3NzA2MjYyNDIsInN1YiI6InRlc3QtdXNlciJ9.jvn--k4ewqL45qVDjoIeAk1BcXm1p3jhjaLpDg5BBokCj1puiuvkA0j94i7PZsCqR9hTFcNZvMFNl1NjDjl88VGXukS7bLZd690JA3Uc2VqXdOVbsndQrkiy-QfvrBOV7Qu_wrdnxf9LtMwxsJvizQbIj8eXYctUeehPcpTtFm1DBgioWND1NQzE_LtobmOyB6m5uA-P0Mhqt6Kel0kaJSKdQ3vQQ9sTSO04QPlbDTSzjZxZ5WGxHueqFbeE6i-0_czVlovkBJMtbxKi2p8TayyJjgt2cbMoVIZiPScEWt2voKOYqWaIvtcGoupfmg8h6rwo2OOsAHQRxBtYsrpWPg
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:22 DEBUG: Sending GET request to http://localhost:8080/jwt-auth-basic/v1.0/protected
2026/02/09 14:07:22 DEBUG: Received response from http://localhost:8080/jwt-auth-basic/v1.0/protected: status=200
    [32mAnd[0m [32mI send a GET request to "http://localhost:8080/jwt-auth-basic/v1.0/protected" with the JWT token[0m [1;30m# <autogenerated>:1 -> *JWTSteps[0m
2026/02/09 14:07:22 Scenario passed: Request with valid JWT token is authorized
    [32mThen[0m [32mthe response status code should be 200[0m                                                          [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Request_without_authorization_header_is_rejected
2026/02/09 14:07:22 Starting scenario: Request without authorization header is rejected

  [1;37mScenario:[0m Request without authorization header is rejected                                       [1;30m# features/jwt-auth.feature:62[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                               [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 493
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: jwt-auth-no-header-api
spec:
  displayName: JWT Auth No Header API
  version: v1.0
  context: /jwt-auth-no-header/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /protected
      policies:
        - name: jwt-auth
          version: v0
          params:
            issuers:
              - mock-jwks
2026/02/09 14:07:22 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:22 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                          [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: jwt-auth-no-header-api[0m
      [36mspec:[0m
      [36m  displayName: JWT Auth No Header API[0m
      [36m  version: v1.0[0m
      [36m  context: /jwt-auth-no-header/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /protected[0m
      [36m      policies:[0m
      [36m        - name: jwt-auth[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            issuers:[0m
      [36m              - mock-jwks[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                         [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/jwt-auth-no-header/v1.0/health" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
    [32mWhen[0m [32mI clear all headers[0m                                                                       [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
REQUEST:
GET /jwt-auth-no-header/v1.0/protected HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Accept-Encoding: gzip


2026/02/09 14:07:22 DEBUG: Sending GET request to http://localhost:8080/jwt-auth-no-header/v1.0/protected
2026/02/09 14:07:22 DEBUG: Received response from http://localhost:8080/jwt-auth-no-header/v1.0/protected: status=401
    [32mAnd[0m [32mI send a GET request to "http://localhost:8080/jwt-auth-no-header/v1.0/protected"[0m          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 401[0m                                                    [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:22 Scenario passed: Request without authorization header is rejected
    [32mAnd[0m [32mthe response body should contain "Authentication failed"[0m                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Request_with_invalid_JWT_token_is_rejected
2026/02/09 14:07:22 Starting scenario: Request with invalid JWT token is rejected

  [1;37mScenario:[0m Request with invalid JWT token is rejected                                                 [1;30m# features/jwt-auth.feature:97[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                   [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 505
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: jwt-auth-invalid-token-api
spec:
  displayName: JWT Auth Invalid Token API
  version: v1.0
  context: /jwt-auth-invalid-token/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /protected
      policies:
        - name: jwt-auth
          version: v0
          params:
            issuers:
              - mock-jwks
2026/02/09 14:07:22 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:22 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                              [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: jwt-auth-invalid-token-api[0m
      [36mspec:[0m
      [36m  displayName: JWT Auth Invalid Token API[0m
      [36m  version: v1.0[0m
      [36m  context: /jwt-auth-invalid-token/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /protected[0m
      [36m      policies:[0m
      [36m        - name: jwt-auth[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            issuers:[0m
      [36m              - mock-jwks[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/jwt-auth-invalid-token/v1.0/health" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
    [32mWhen[0m [32mI clear all headers[0m                                                                           [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mAnd[0m [32mI set header "Authorization" to "Bearer invalid.jwt.token"[0m                                     [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
REQUEST:
GET /jwt-auth-invalid-token/v1.0/protected HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Bearer invalid.jwt.token
Accept-Encoding: gzip


2026/02/09 14:07:23 DEBUG: Sending GET request to http://localhost:8080/jwt-auth-invalid-token/v1.0/protected
2026/02/09 14:07:23 DEBUG: Received response from http://localhost:8080/jwt-auth-invalid-token/v1.0/protected: status=401
    [32mAnd[0m [32mI send a GET request to "http://localhost:8080/jwt-auth-invalid-token/v1.0/protected"[0m          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 401[0m                                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:23 Scenario passed: Request with invalid JWT token is rejected
    [32mAnd[0m [32mthe response body should contain "Authentication failed"[0m                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Request_with_malformed_Bearer_header_is_rejected
2026/02/09 14:07:23 Starting scenario: Request with malformed Bearer header is rejected

  [1;37mScenario:[0m Request with malformed Bearer header is rejected                                              [1;30m# features/jwt-auth.feature:133[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                      [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 514
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: jwt-auth-malformed-header-api
spec:
  displayName: JWT Auth Malformed Header API
  version: v1.0
  context: /jwt-auth-malformed-header/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /protected
      policies:
        - name: jwt-auth
          version: v0
          params:
            issuers:
              - mock-jwks
2026/02/09 14:07:23 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:23 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                 [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: jwt-auth-malformed-header-api[0m
      [36mspec:[0m
      [36m  displayName: JWT Auth Malformed Header API[0m
      [36m  version: v1.0[0m
      [36m  context: /jwt-auth-malformed-header/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /protected[0m
      [36m      policies:[0m
      [36m        - name: jwt-auth[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            issuers:[0m
      [36m              - mock-jwks[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/jwt-auth-malformed-header/v1.0/health" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
    [32mWhen[0m [32mI clear all headers[0m                                                                              [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mAnd[0m [32mI set header "Authorization" to "NotBearer sometoken"[0m                                             [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
REQUEST:
GET /jwt-auth-malformed-header/v1.0/protected HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: NotBearer sometoken
Accept-Encoding: gzip


2026/02/09 14:07:23 DEBUG: Sending GET request to http://localhost:8080/jwt-auth-malformed-header/v1.0/protected
2026/02/09 14:07:23 DEBUG: Received response from http://localhost:8080/jwt-auth-malformed-header/v1.0/protected: status=401
    [32mAnd[0m [32mI send a GET request to "http://localhost:8080/jwt-auth-malformed-header/v1.0/protected"[0m          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:23 Scenario passed: Request with malformed Bearer header is rejected
    [32mThen[0m [32mthe response status code should be 401[0m                                                           [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Request_with_wrong_issuer_is_rejected
2026/02/09 14:07:23 Starting scenario: Request with wrong issuer is rejected

  [1;37mScenario:[0m Request with wrong issuer is rejected                                                               [1;30m# features/jwt-auth.feature:168[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                            [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 508
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: jwt-auth-wrong-issuer-api
spec:
  displayName: JWT Auth Wrong Issuer API
  version: v1.0
  context: /jwt-auth-wrong-issuer/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /protected
      policies:
        - name: jwt-auth
          version: v0
          params:
            issuers:
              - wrong-issuer-km
2026/02/09 14:07:23 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:23 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                       [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: jwt-auth-wrong-issuer-api[0m
      [36mspec:[0m
      [36m  displayName: JWT Auth Wrong Issuer API[0m
      [36m  version: v1.0[0m
      [36m  context: /jwt-auth-wrong-issuer/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /protected[0m
      [36m      policies:[0m
      [36m        - name: jwt-auth[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            issuers:[0m
      [36m              - wrong-issuer-km[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/jwt-auth-wrong-issuer/v1.0/health" to be ready[0m           [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:24 DEBUG: Fetching JWT token from http://localhost:8082/token?issuer=http%3A%2F%2Fmock-jwks%3A8080%2Ftoken
2026/02/09 14:07:24 DEBUG: Obtained JWT token (length: 555)
    [32mWhen[0m [32mI get a JWT token from the mock JWKS server with issuer "http://mock-jwks:8080/token"[0m                  [1;30m# <autogenerated>:1 -> *JWTSteps[0m
REQUEST:
GET /jwt-auth-wrong-issuer/v1.0/protected HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6InRlc3Qta2V5LWlkIiwidHlwIjoiSldUIn0.eyJhdWQiOiJ0ZXN0LWF1ZGllbmNlIiwiZXhwIjoxNzcwNjI5ODQ0LCJpc3MiOiJodHRwOi8vbW9jay1qd2tzOjgwODAvdG9rZW4iLCJuYmYiOjE3NzA2MjYyNDQsInN1YiI6InRlc3QtdXNlciJ9.neZ4DR5uDQMOtcUBZDw60XNAzehgI5TWsqO2-suiim07jD9wi29fET3pRCpYYp_XLsXfpkHbHN8HUU8aGR-vYSTZFJSOTrZy-7tU4vgYaSjaB4QNhqnzlWowNubFnZAeKNvr89o0HSMRyRIekeiTQJ9l_ZGfeGnLQ9t0cP5gaFPIb2n4l3tRElSIRWlTHtkNOArTguTY8viCjxn4xJzCbcBMqVVc15hyOWFkh3Y_Bpb4UxKCqikcPJhaIQj5NipGqDo0OHkh9_hlJ50jjP8h2zRhZWtFjISSXEQ6MlSbPyb4dKhG0ORhLKBWXX-SxZHQ5PGowpBcl8hn1J5Z3LUoyw
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:24 DEBUG: Sending GET request to http://localhost:8080/jwt-auth-wrong-issuer/v1.0/protected
2026/02/09 14:07:24 DEBUG: Received response from http://localhost:8080/jwt-auth-wrong-issuer/v1.0/protected: status=401
    [32mAnd[0m [32mI send a GET request to "http://localhost:8080/jwt-auth-wrong-issuer/v1.0/protected" with the JWT token[0m [1;30m# <autogenerated>:1 -> *JWTSteps[0m
    [32mThen[0m [32mthe response status code should be 401[0m                                                                 [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:24 Scenario passed: Request with wrong issuer is rejected
    [32mAnd[0m [32mthe response body should contain "Authentication failed"[0m                                                [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/JWT_authentication_with_audience_validation
2026/02/09 14:07:24 Starting scenario: JWT authentication with audience validation

  [1;37mScenario:[0m JWT authentication with audience validation                                                     [1;30m# features/jwt-auth.feature:204[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                        [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 545
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: jwt-auth-audience-api
spec:
  displayName: JWT Auth Audience API
  version: v1.0
  context: /jwt-auth-audience/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /protected
      policies:
        - name: jwt-auth
          version: v0
          params:
            issuers:
              - mock-jwks
            audiences:
              - "test-audience"
2026/02/09 14:07:24 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:24 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                   [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: jwt-auth-audience-api[0m
      [36mspec:[0m
      [36m  displayName: JWT Auth Audience API[0m
      [36m  version: v1.0[0m
      [36m  context: /jwt-auth-audience/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /protected[0m
      [36m      policies:[0m
      [36m        - name: jwt-auth[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            issuers:[0m
      [36m              - mock-jwks[0m
      [36m            audiences:[0m
      [36m              - "test-audience"[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/jwt-auth-audience/v1.0/health" to be ready[0m           [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:24 DEBUG: Fetching JWT token from http://localhost:8082/token?issuer=http%3A%2F%2Fmock-jwks%3A8080%2Ftoken
2026/02/09 14:07:24 DEBUG: Obtained JWT token (length: 555)
    [32mWhen[0m [32mI get a JWT token from the mock JWKS server with issuer "http://mock-jwks:8080/token"[0m              [1;30m# <autogenerated>:1 -> *JWTSteps[0m
REQUEST:
GET /jwt-auth-audience/v1.0/protected HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6InRlc3Qta2V5LWlkIiwidHlwIjoiSldUIn0.eyJhdWQiOiJ0ZXN0LWF1ZGllbmNlIiwiZXhwIjoxNzcwNjI5ODQ1LCJpc3MiOiJodHRwOi8vbW9jay1qd2tzOjgwODAvdG9rZW4iLCJuYmYiOjE3NzA2MjYyNDUsInN1YiI6InRlc3QtdXNlciJ9.rPE50VCU6W3LfLFEhYasa1HgPtGc88i6VtQtETlttDRrFty_hK5itdtgo5MHBqu10suDUAXA7pfLRqAovwju6-hTgMifXODMkg3JUh0vtrE5Je58juRkylAvWjdoXPlMIhr23I3M9WaV6lqXcXsoP0knBywa5_1jsDrfLI4uPOtByTtIg3iOumcX6m1_V8JOcStHn-nl0yzxevra2FiEeWjSIW4B426y4jcBE8reLa6v_wxX_ddllCDUGhwr6GNIO5cLfHv83tKKLOfy5UDq5wcFdB9K2BkVqCkfiIY5Q3GOEo9dRkKsPP2AxnBvzDQ9w-d4EkdrSCs0V_SH1ntO-w
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:24 DEBUG: Sending GET request to http://localhost:8080/jwt-auth-audience/v1.0/protected
2026/02/09 14:07:24 DEBUG: Received response from http://localhost:8080/jwt-auth-audience/v1.0/protected: status=200
    [32mAnd[0m [32mI send a GET request to "http://localhost:8080/jwt-auth-audience/v1.0/protected" with the JWT token[0m [1;30m# <autogenerated>:1 -> *JWTSteps[0m
2026/02/09 14:07:24 Scenario passed: JWT authentication with audience validation
    [32mThen[0m [32mthe response status code should be 200[0m                                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/JWT_authentication_rejects_wrong_audience
2026/02/09 14:07:24 Starting scenario: JWT authentication rejects wrong audience

  [1;37mScenario:[0m JWT authentication rejects wrong audience                                                             [1;30m# features/jwt-auth.feature:240[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                              [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 567
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: jwt-auth-wrong-audience-api
spec:
  displayName: JWT Auth Wrong Audience API
  version: v1.0
  context: /jwt-auth-wrong-audience/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /protected
      policies:
        - name: jwt-auth
          version: v0
          params:
            issuers:
              - mock-jwks
            audiences:
              - "expected-audience"
2026/02/09 14:07:24 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:24 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                         [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: jwt-auth-wrong-audience-api[0m
      [36mspec:[0m
      [36m  displayName: JWT Auth Wrong Audience API[0m
      [36m  version: v1.0[0m
      [36m  context: /jwt-auth-wrong-audience/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /protected[0m
      [36m      policies:[0m
      [36m        - name: jwt-auth[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            issuers:[0m
      [36m              - mock-jwks[0m
      [36m            audiences:[0m
      [36m              - "expected-audience"[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                        [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/jwt-auth-wrong-audience/v1.0/health" to be ready[0m           [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:25 DEBUG: Fetching JWT token from http://localhost:8082/token?issuer=http%3A%2F%2Fmock-jwks%3A8080%2Ftoken
2026/02/09 14:07:25 DEBUG: Obtained JWT token (length: 555)
    [32mWhen[0m [32mI get a JWT token from the mock JWKS server with issuer "http://mock-jwks:8080/token"[0m                    [1;30m# <autogenerated>:1 -> *JWTSteps[0m
REQUEST:
GET /jwt-auth-wrong-audience/v1.0/protected HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6InRlc3Qta2V5LWlkIiwidHlwIjoiSldUIn0.eyJhdWQiOiJ0ZXN0LWF1ZGllbmNlIiwiZXhwIjoxNzcwNjI5ODQ1LCJpc3MiOiJodHRwOi8vbW9jay1qd2tzOjgwODAvdG9rZW4iLCJuYmYiOjE3NzA2MjYyNDUsInN1YiI6InRlc3QtdXNlciJ9.rPE50VCU6W3LfLFEhYasa1HgPtGc88i6VtQtETlttDRrFty_hK5itdtgo5MHBqu10suDUAXA7pfLRqAovwju6-hTgMifXODMkg3JUh0vtrE5Je58juRkylAvWjdoXPlMIhr23I3M9WaV6lqXcXsoP0knBywa5_1jsDrfLI4uPOtByTtIg3iOumcX6m1_V8JOcStHn-nl0yzxevra2FiEeWjSIW4B426y4jcBE8reLa6v_wxX_ddllCDUGhwr6GNIO5cLfHv83tKKLOfy5UDq5wcFdB9K2BkVqCkfiIY5Q3GOEo9dRkKsPP2AxnBvzDQ9w-d4EkdrSCs0V_SH1ntO-w
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:25 DEBUG: Sending GET request to http://localhost:8080/jwt-auth-wrong-audience/v1.0/protected
2026/02/09 14:07:25 DEBUG: Received response from http://localhost:8080/jwt-auth-wrong-audience/v1.0/protected: status=401
    [32mAnd[0m [32mI send a GET request to "http://localhost:8080/jwt-auth-wrong-audience/v1.0/protected" with the JWT token[0m [1;30m# <autogenerated>:1 -> *JWTSteps[0m
    [32mThen[0m [32mthe response status code should be 401[0m                                                                   [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:25 Scenario passed: JWT authentication rejects wrong audience
    [32mAnd[0m [32mthe response body should contain "Authentication failed"[0m                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Multiple_key_managers_with_issuer_matching
2026/02/09 14:07:25 Starting scenario: Multiple key managers with issuer matching

  [1;37mScenario:[0m Multiple key managers with issuer matching                                                      [1;30m# features/jwt-auth.feature:278[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                        [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 538
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: jwt-auth-multi-keymanager-api
spec:
  displayName: JWT Auth Multi KeyManager API
  version: v1.0
  context: /jwt-auth-multi-km/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /protected
      policies:
        - name: jwt-auth
          version: v0
          params:
            issuers:
              - mock-jwks
              - wrong-issuer-km
2026/02/09 14:07:25 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:25 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                                   [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: jwt-auth-multi-keymanager-api[0m
      [36mspec:[0m
      [36m  displayName: JWT Auth Multi KeyManager API[0m
      [36m  version: v1.0[0m
      [36m  context: /jwt-auth-multi-km/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /protected[0m
      [36m      policies:[0m
      [36m        - name: jwt-auth[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            issuers:[0m
      [36m              - mock-jwks[0m
      [36m              - wrong-issuer-km[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/jwt-auth-multi-km/v1.0/health" to be ready[0m           [1;30m# <autogenerated>:1 -> *HealthSteps[0m
2026/02/09 14:07:25 DEBUG: Fetching JWT token from http://localhost:8082/token?issuer=http%3A%2F%2Fmock-jwks%3A8080%2Ftoken
2026/02/09 14:07:25 DEBUG: Obtained JWT token (length: 555)
    [32mWhen[0m [32mI get a JWT token from the mock JWKS server with issuer "http://mock-jwks:8080/token"[0m              [1;30m# <autogenerated>:1 -> *JWTSteps[0m
REQUEST:
GET /jwt-auth-multi-km/v1.0/protected HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6InRlc3Qta2V5LWlkIiwidHlwIjoiSldUIn0.eyJhdWQiOiJ0ZXN0LWF1ZGllbmNlIiwiZXhwIjoxNzcwNjI5ODQ2LCJpc3MiOiJodHRwOi8vbW9jay1qd2tzOjgwODAvdG9rZW4iLCJuYmYiOjE3NzA2MjYyNDYsInN1YiI6InRlc3QtdXNlciJ9.VUn82patsvIiy7AFqC9kMgZk6TZni3UE0W82-Ui55KELPMvY_N7gsjJ_LBh1IIfC2qLsXQ2swwmkk8J3oAwOXeAt10EHubMbZlRyh2-lvV-vllozWrD3wni9Tp9WbNN2C82WnY_CIUtn4Cyh_8J1FIVIUOndvWzIK6K-1pCWum3veN3ovbsnnhu6BVZAVPYv_0cW0Gf36ixPKZnE3epCOLU6FR5qnBO_5HyBjBU_RtgdFsl_juYywvVKx6grpMQKNVZxHUXTJ6eChv1tc-pGW_OdjGvEbaata_g-tOsSIm_7aS3J5BeEn7ai1Rx5TRyFfYfevb9-qd4L1zlEOg_Ebw
Content-Type: application/yaml
Accept-Encoding: gzip


2026/02/09 14:07:25 DEBUG: Sending GET request to http://localhost:8080/jwt-auth-multi-km/v1.0/protected
2026/02/09 14:07:26 DEBUG: Received response from http://localhost:8080/jwt-auth-multi-km/v1.0/protected: status=200
    [32mAnd[0m [32mI send a GET request to "http://localhost:8080/jwt-auth-multi-km/v1.0/protected" with the JWT token[0m [1;30m# <autogenerated>:1 -> *JWTSteps[0m
2026/02/09 14:07:26 Scenario passed: Multiple key managers with issuer matching
    [32mThen[0m [32mthe response status code should be 200[0m                                                             [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/JWT_auth_does_not_affect_unprotected_endpoints
2026/02/09 14:07:26 Starting scenario: JWT auth does not affect unprotected endpoints

  [1;37mScenario:[0m JWT auth does not affect unprotected endpoints                                       [1;30m# features/jwt-auth.feature:314[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                             [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 487
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: jwt-auth-partial-api
spec:
  displayName: JWT Auth Partial API
  version: v1.0
  context: /jwt-auth-partial/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /public
    - method: GET
      path: /protected
      policies:
        - name: jwt-auth
          version: v0
          params:
            issuers:
              - mock-jwks
2026/02/09 14:07:26 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:26 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                        [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: jwt-auth-partial-api[0m
      [36mspec:[0m
      [36m  displayName: JWT Auth Partial API[0m
      [36m  version: v1.0[0m
      [36m  context: /jwt-auth-partial/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /public[0m
      [36m    - method: GET[0m
      [36m      path: /protected[0m
      [36m      policies:[0m
      [36m        - name: jwt-auth[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            issuers:[0m
      [36m              - mock-jwks[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/jwt-auth-partial/v1.0/public" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
    [32mWhen[0m [32mI clear all headers[0m                                                                     [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
REQUEST:
GET /jwt-auth-partial/v1.0/public HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Accept-Encoding: gzip


2026/02/09 14:07:26 DEBUG: Sending GET request to http://localhost:8080/jwt-auth-partial/v1.0/public
2026/02/09 14:07:26 DEBUG: Received response from http://localhost:8080/jwt-auth-partial/v1.0/public: status=200
    [32mAnd[0m [32mI send a GET request to "http://localhost:8080/jwt-auth-partial/v1.0/public"[0m             [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mThen[0m [32mthe response status code should be 200[0m                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
REQUEST:
GET /jwt-auth-partial/v1.0/protected HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Accept-Encoding: gzip


2026/02/09 14:07:26 DEBUG: Sending GET request to http://localhost:8080/jwt-auth-partial/v1.0/protected
2026/02/09 14:07:26 DEBUG: Received response from http://localhost:8080/jwt-auth-partial/v1.0/protected: status=401
    [32mWhen[0m [32mI send a GET request to "http://localhost:8080/jwt-auth-partial/v1.0/protected"[0m         [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:26 Scenario passed: JWT auth does not affect unprotected endpoints
    [32mThen[0m [32mthe response status code should be 401[0m                                                  [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Empty_Bearer_token_is_rejected
2026/02/09 14:07:26 Starting scenario: Empty Bearer token is rejected

  [1;37mScenario:[0m Empty Bearer token is rejected                                                            [1;30m# features/jwt-auth.feature:353[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                  [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 502
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: jwt-auth-empty-bearer-api
spec:
  displayName: JWT Auth Empty Bearer API
  version: v1.0
  context: /jwt-auth-empty-bearer/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /protected
      policies:
        - name: jwt-auth
          version: v0
          params:
            issuers:
              - mock-jwks
2026/02/09 14:07:26 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:26 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                             [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: jwt-auth-empty-bearer-api[0m
      [36mspec:[0m
      [36m  displayName: JWT Auth Empty Bearer API[0m
      [36m  version: v1.0[0m
      [36m  context: /jwt-auth-empty-bearer/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /protected[0m
      [36m      policies:[0m
      [36m        - name: jwt-auth[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            issuers:[0m
      [36m              - mock-jwks[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                            [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/jwt-auth-empty-bearer/v1.0/health" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
    [32mWhen[0m [32mI clear all headers[0m                                                                          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mAnd[0m [32mI set header "Authorization" to "Bearer "[0m                                                     [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
REQUEST:
GET /jwt-auth-empty-bearer/v1.0/protected HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Bearer
Accept-Encoding: gzip


2026/02/09 14:07:27 DEBUG: Sending GET request to http://localhost:8080/jwt-auth-empty-bearer/v1.0/protected
2026/02/09 14:07:27 DEBUG: Received response from http://localhost:8080/jwt-auth-empty-bearer/v1.0/protected: status=401
    [32mAnd[0m [32mI send a GET request to "http://localhost:8080/jwt-auth-empty-bearer/v1.0/protected"[0m          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:27 Scenario passed: Empty Bearer token is rejected
    [32mThen[0m [32mthe response status code should be 401[0m                                                       [1;30m# <autogenerated>:1 -> *AssertSteps[0m
=== RUN   TestFeatures/Bearer-only_without_token_is_rejected
2026/02/09 14:07:27 Starting scenario: Bearer-only without token is rejected

  [1;37mScenario:[0m Bearer-only without token is rejected                                                    [1;30m# features/jwt-auth.feature:388[0m
    [32mGiven[0m [32mI authenticate using basic auth as "admin"[0m                                                 [1;30m# steps_common.go:31 -> github.com/wso2/api-platform/gateway/it.RegisterAuthSteps.func1[0m
REQUEST:
POST /apis HTTP/1.1
Host: localhost:9090
User-Agent: Go-http-client/1.1
Content-Length: 499
Authorization: Basic YWRtaW46YWRtaW4=
Content-Type: application/yaml
Accept-Encoding: gzip

apiVersion: gateway.api-platform.wso2.com/v1alpha1
kind: RestApi
metadata:
  name: jwt-auth-bearer-only-api
spec:
  displayName: JWT Auth Bearer Only API
  version: v1.0
  context: /jwt-auth-bearer-only/$version
  upstream:
    main:
      url: http://sample-backend:9080/api/v1
  operations:
    - method: GET
      path: /health
    - method: GET
      path: /protected
      policies:
        - name: jwt-auth
          version: v0
          params:
            issuers:
              - mock-jwks
2026/02/09 14:07:27 DEBUG: Sending POST request to http://localhost:9090/apis
2026/02/09 14:07:27 DEBUG: Received response from http://localhost:9090/apis: status=201
    [32mWhen[0m [32mI deploy this API configuration:[0m                                                            [1;30m# steps_api.go:36 -> github.com/wso2/api-platform/gateway/it.RegisterAPISteps.func1[0m
      [36m"""[0m
      [36mapiVersion: gateway.api-platform.wso2.com/v1alpha1[0m
      [36mkind: RestApi[0m
      [36mmetadata:[0m
      [36m  name: jwt-auth-bearer-only-api[0m
      [36mspec:[0m
      [36m  displayName: JWT Auth Bearer Only API[0m
      [36m  version: v1.0[0m
      [36m  context: /jwt-auth-bearer-only/$version[0m
      [36m  upstream:[0m
      [36m    main:[0m
      [36m      url: http://sample-backend:9080/api/v1[0m
      [36m  operations:[0m
      [36m    - method: GET[0m
      [36m      path: /health[0m
      [36m    - method: GET[0m
      [36m      path: /protected[0m
      [36m      policies:[0m
      [36m        - name: jwt-auth[0m
      [36m          version: v0[0m
      [36m          params:[0m
      [36m            issuers:[0m
      [36m              - mock-jwks[0m
      [36m"""[0m
    [32mThen[0m [32mthe response should be successful[0m                                                           [1;30m# <autogenerated>:1 -> *AssertSteps[0m
    [32mAnd[0m [32mI wait for the endpoint "http://localhost:8080/jwt-auth-bearer-only/v1.0/health" to be ready[0m [1;30m# <autogenerated>:1 -> *HealthSteps[0m
    [32mWhen[0m [32mI clear all headers[0m                                                                         [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
    [32mAnd[0m [32mI set header "Authorization" to "Bearer"[0m                                                     [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
REQUEST:
GET /jwt-auth-bearer-only/v1.0/protected HTTP/1.1
Host: localhost:8080
User-Agent: Go-http-client/1.1
Authorization: Bearer
Accept-Encoding: gzip


2026/02/09 14:07:27 DEBUG: Sending GET request to http://localhost:8080/jwt-auth-bearer-only/v1.0/protected
2026/02/09 14:07:27 DEBUG: Received response from http://localhost:8080/jwt-auth-bearer-only/v1.0/protected: status=401
    [32mAnd[0m [32mI send a GET request to "http://localhost:8080/jwt-auth-bearer-only/v1.0/protected"[0m          [1;30m# <autogenerated>:1 -> *HTTPSteps[0m
2026/02/09 14:07:27 Scenario passed: Bearer-only without token is rejected
    [32mThen[0m [32mthe response status code should be 401[0m                                                      [1;30m# <autogenerated>:1 -> *AssertSteps[0m
2026/02/09 14:07:27 === Integration Test Suite Cleanup ===
2026/02/09 14:07:27 Cleaning up Docker Compose services...
2026/02/09 14:07:27 Stopping containers gracefully (waiting for coverage flush)...
 Container it-mock-analytics-collector  Stopping
 Container it-mock-openapi-https  Stopping
 Container it-mock-azure-content-safety  Stopping
 Container it-echo-backend  Stopping
 Container it-mock-embedding-provider  Stopping
 Container it-router  Stopping
 Container it-mock-aws-bedrock-guardrail  Stopping
 Container it-redis  Stopping
 Container it-policy-engine  Stopping
 Container it-sample-backend  Stopping
 Container mcp-server-backend  Stopping
 Container it-mock-jwks  Stopping
 Container it-mock-azure-content-safety  Stopped
 Container it-mock-aws-bedrock-guardrail  Stopped
 Container it-mock-openapi-https  Stopped
 Container it-mock-embedding-provider  Stopped
 Container it-sample-backend  Stopped
 Container it-mock-analytics-collector  Stopped
 Container it-policy-engine  Stopped
 Container it-mock-jwks  Stopped
 Container it-redis  Stopped
 Container it-router  Stopped
 Container it-gateway-controller  Stopping
 Container it-mock-openapi  Stopping
 Container it-gateway-controller  Stopped
 Container it-postgres  Stopping
 Container it-mock-openapi  Stopped
 Container it-postgres  Stopped
 Container it-echo-backend  Stopped
 Container mcp-server-backend  Stopped
2026/02/09 14:07:43 Waiting for coverage data to be written...
 Container it-sample-backend  Stopping
 Container it-mock-openapi-https  Stopping
 Container it-echo-backend  Stopping
 Container it-router  Stopping
 Container it-mock-azure-content-safety  Stopping
 Container it-redis  Stopping
 Container mcp-server-backend  Stopping
 Container it-mock-embedding-provider  Stopping
 Container it-mock-aws-bedrock-guardrail  Stopping
 Container it-mock-jwks  Stopping
 Container it-policy-engine  Stopping
 Container it-mock-analytics-collector  Stopping
 Container it-mock-aws-bedrock-guardrail  Stopped
 Container it-mock-aws-bedrock-guardrail  Removing
 Container it-echo-backend  Stopped
 Container it-echo-backend  Removing
 Container it-mock-embedding-provider  Stopped
 Container it-mock-embedding-provider  Removing
 Container mcp-server-backend  Stopped
 Container mcp-server-backend  Removing
 Container it-mock-azure-content-safety  Stopped
 Container it-mock-azure-content-safety  Removing
 Container it-router  Stopped
 Container it-router  Removing
 Container it-redis  Stopped
 Container it-redis  Removing
 Container it-policy-engine  Stopped
 Container it-policy-engine  Removing
 Container it-sample-backend  Stopped
 Container it-sample-backend  Removing
 Container it-mock-openapi-https  Stopped
 Container it-mock-openapi-https  Removing
 Container it-mock-analytics-collector  Stopped
 Container it-mock-analytics-collector  Removing
 Container it-mock-jwks  Stopped
 Container it-mock-jwks  Removing
 Container it-mock-azure-content-safety  Removed
 Container it-mock-aws-bedrock-guardrail  Removed
 Container it-mock-analytics-collector  Removed
 Container mcp-server-backend  Removed
 Container it-sample-backend  Removed
 Container it-redis  Removed
 Container it-policy-engine  Removed
 Container it-echo-backend  Removed
 Container it-mock-jwks  Removed
 Container it-mock-openapi-https  Removed
 Container it-router  Removed
 Container it-mock-openapi  Stopping
 Container it-gateway-controller  Stopping
 Container it-mock-embedding-provider  Removed
 Container it-gateway-controller  Stopped
 Container it-gateway-controller  Removing
 Container it-mock-openapi  Stopped
 Container it-mock-openapi  Removing
 Container it-gateway-controller  Removed
 Container it-postgres  Stopping
 Container it-postgres  Stopped
 Container it-postgres  Removing
 Container it-mock-openapi  Removed
 Container it-postgres  Removed
 Volume gateway-it_controller-data-tests  Removing
 Network gateway-it_it-gateway-network  Removing
 Volume gateway-it_controller-data-tests  Removed
 Network gateway-it_it-gateway-network  Removed
2026/02/09 14:07:46 Cleanup complete
2026/02/09 14:07:46 Generating coverage reports...
2026/02/09 14:07:46 Generating coverage reports...
2026/02/09 14:07:48 No coverage data found for gateway-controller
2026/02/09 14:07:48 No coverage data found for policy-engine
2026/02/09 14:07:48 Coverage reports generated in coverage
2026/02/09 14:07:48 Generating test reports...

╔══════════════════════════════════════════════════════════════════════════╗
║                       TEST RESULTS SUMMARY                               ║
╠══════════════════════════════════════════════════════════════════════════╣
║  Suite: Gateway Integration Tests                                        ║
║  Duration: 83.1s                                                         ║
╠══════════════════════════════════════════════════════════════════════════╣
║  SCENARIOS                                                               ║
╠────────────────────────────────────────────────────┬────────┬────────────╣
║  Name                                              │ Status │  Duration  ║
╠────────────────────────────────────────────────────┼────────┼────────────╣
║  Gateway controller health endpoint returns OK     │ PASS   │       0.0s ║
║  Router is ready to accept traffic                 │ PASS   │       0.0s ║
║  All gateway services are healthy                  │ PASS   │       0.0s ║
║  Gateway controller health endpoint returns val... │ PASS   │       0.0s ║
║  Gateway controller health endpoint is accessib... │ PASS   │       0.0s ║
║  Deploy a simple HTTP API and invoke it success... │ PASS   │       3.1s ║
║  Deploy an HTTP API with labels and verify they... │ PASS   │       3.0s ║
║  Deploy an HTTP API with invalid labels (spaces... │ PASS   │       0.5s ║
║  Enforce rate limit on API resource                │ PASS   │       0.5s ║
║  Multi-quota rate limit headers in IETF format     │ PASS   │       0.5s ║
║  429 response includes IETF RateLimit headers f... │ PASS   │       0.5s ║
║  Rate limit headers are returned                   │ PASS   │       0.5s ║
║  Custom rate limit error response                  │ PASS   │       0.5s ║
║  Basic rate limiting without cost extraction       │ PASS   │       0.5s ║
║  Cost extraction from response body using echo ... │ PASS   │       0.6s ║
║  API-level rate limiting with apiname key extra... │ PASS   │       0.5s ║
║  Updating API does not reset rate limit state      │ PASS   │       3.0s ║
║  Multi-dimensional rate limiting with quotas       │ PASS   │       0.5s ║
║  Per-quota cost extraction with multiplier         │ PASS   │       0.5s ║
║  Header-based key extraction for per-user rate ... │ PASS   │       0.5s ║
║  Multiple limits per quota - enforces most rest... │ PASS   │       3.1s ║
║  Cost extraction from request body                 │ PASS   │       0.5s ║
║  Multiple quotas with prompt and completion tok... │ PASS   │       0.6s ║
║  IP-based rate limiting using X-Forwarded-For h... │ PASS   │       0.5s ║
║  Cost extraction from request header               │ PASS   │       0.5s ║
║  Composite key extraction with multiple components │ PASS   │       0.5s ║
║  Default cost fallback when extraction fails       │ PASS   │       0.5s ║
║  Different APIs with apiname key extraction hav... │ PASS   │       1.1s ║
║  Resource grouping using constant key extraction   │ PASS   │       0.5s ║
║  CEL expression based key extraction for per-us... │ PASS   │       0.5s ║
║  CEL expression based composite key extraction     │ PASS   │       0.5s ║
║  CEL expression based cost extraction from requ... │ PASS   │       0.5s ║
║  Request with valid JWT token is authorized        │ PASS   │       0.5s ║
║  Request without authorization header is rejected  │ PASS   │       0.5s ║
║  Request with invalid JWT token is rejected        │ PASS   │       0.5s ║
║  Request with malformed Bearer header is rejected  │ PASS   │       0.5s ║
║  Request with wrong issuer is rejected             │ PASS   │       0.5s ║
║  JWT authentication with audience validation       │ PASS   │       0.5s ║
║  JWT authentication rejects wrong audience         │ PASS   │       0.5s ║
║  Multiple key managers with issuer matching        │ PASS   │       0.5s ║
║  JWT auth does not affect unprotected endpoints    │ PASS   │       0.6s ║
║  Empty Bearer token is rejected                    │ PASS   │       0.5s ║
║  Bearer-only without token is rejected             │ PASS   │       0.5s ║
╠══════════════════════════════════════════════════════════════════════════╣
║  SUMMARY                                                                 ║
╠─────────────┬────────────┬────────────┬────────────┬─────────────────────╣
║    Total    │   Passed   │   Failed   │  Skipped   │       Result        ║
╠─────────────┼────────────┼────────────┼────────────┼─────────────────────╣
║      43     │      43    │       0    │       0    │        PASS         ║
╚══════════════════════════════════════════════════════════════════════════╝

2026/02/09 14:07:48 Test report saved to: reports/integration-test-results.json
2026/02/09 14:07:48 === Test Suite Complete ===

43 scenarios ([32m43 passed[0m)
493 steps ([32m493 passed[0m)
1m23.111670083s
--- PASS: TestFeatures (83.11s)
    --- PASS: TestFeatures/Gateway_controller_health_endpoint_returns_OK (0.00s)
    --- PASS: TestFeatures/Router_is_ready_to_accept_traffic (0.00s)
    --- PASS: TestFeatures/All_gateway_services_are_healthy (0.00s)
    --- PASS: TestFeatures/Gateway_controller_health_endpoint_returns_valid_JSON (0.00s)
    --- PASS: TestFeatures/Gateway_controller_health_endpoint_is_accessible_without_authentication (0.00s)
    --- PASS: TestFeatures/Deploy_a_simple_HTTP_API_and_invoke_it_successfully (3.06s)
    --- PASS: TestFeatures/Deploy_an_HTTP_API_with_labels_and_verify_they_are_stored (3.02s)
    --- PASS: TestFeatures/Deploy_an_HTTP_API_with_invalid_labels_(spaces_in_keys)_should_fail (0.51s)
    --- PASS: TestFeatures/Enforce_rate_limit_on_API_resource (0.54s)
    --- PASS: TestFeatures/Multi-quota_rate_limit_headers_in_IETF_format (0.52s)
    --- PASS: TestFeatures/429_response_includes_IETF_RateLimit_headers_for_violated_quota (0.53s)
    --- PASS: TestFeatures/Rate_limit_headers_are_returned (0.53s)
    --- PASS: TestFeatures/Custom_rate_limit_error_response (0.53s)
    --- PASS: TestFeatures/Basic_rate_limiting_without_cost_extraction (0.53s)
    --- PASS: TestFeatures/Cost_extraction_from_response_body_using_echo_backend (0.58s)
    --- PASS: TestFeatures/API-level_rate_limiting_with_apiname_key_extraction (0.55s)
    --- PASS: TestFeatures/Updating_API_does_not_reset_rate_limit_state (3.03s)
    --- PASS: TestFeatures/Multi-dimensional_rate_limiting_with_quotas (0.55s)
    --- PASS: TestFeatures/Per-quota_cost_extraction_with_multiplier (0.54s)
    --- PASS: TestFeatures/Header-based_key_extraction_for_per-user_rate_limiting (0.53s)
    --- PASS: TestFeatures/Multiple_limits_per_quota_-_enforces_most_restrictive_limit (3.08s)
    --- PASS: TestFeatures/Cost_extraction_from_request_body (0.53s)
    --- PASS: TestFeatures/Multiple_quotas_with_prompt_and_completion_token_cost_extraction (0.62s)
    --- PASS: TestFeatures/IP-based_rate_limiting_using_X-Forwarded-For_header (0.54s)
    --- PASS: TestFeatures/Cost_extraction_from_request_header (0.52s)
    --- PASS: TestFeatures/Composite_key_extraction_with_multiple_components (0.53s)
    --- PASS: TestFeatures/Default_cost_fallback_when_extraction_fails (0.53s)
    --- PASS: TestFeatures/Different_APIs_with_apiname_key_extraction_have_isolated_quotas (1.08s)
    --- PASS: TestFeatures/Resource_grouping_using_constant_key_extraction (0.53s)
    --- PASS: TestFeatures/CEL_expression_based_key_extraction_for_per-user_rate_limiting (0.54s)
    --- PASS: TestFeatures/CEL_expression_based_composite_key_extraction (0.53s)
    --- PASS: TestFeatures/CEL_expression_based_cost_extraction_from_request_header (0.52s)
    --- PASS: TestFeatures/Request_with_valid_JWT_token_is_authorized (0.54s)
    --- PASS: TestFeatures/Request_without_authorization_header_is_rejected (0.53s)
    --- PASS: TestFeatures/Request_with_invalid_JWT_token_is_rejected (0.51s)
    --- PASS: TestFeatures/Request_with_malformed_Bearer_header_is_rejected (0.51s)
    --- PASS: TestFeatures/Request_with_wrong_issuer_is_rejected (0.51s)
    --- PASS: TestFeatures/JWT_authentication_with_audience_validation (0.52s)
    --- PASS: TestFeatures/JWT_authentication_rejects_wrong_audience (0.53s)
    --- PASS: TestFeatures/Multiple_key_managers_with_issuer_matching (0.53s)
    --- PASS: TestFeatures/JWT_auth_does_not_affect_unprotected_endpoints (0.58s)
    --- PASS: TestFeatures/Empty_Bearer_token_is_rejected (0.52s)
    --- PASS: TestFeatures/Bearer-only_without_token_is_rejected (0.52s)
PASS
ok  	github.com/wso2/api-platform/gateway/it	84.127s
?   	github.com/wso2/api-platform/gateway/it/steps	[no test files]
