version: v1

# Global retention settings
# Events are stored when clients are disconnected and replayed on reconnect
retention:
  enabled: true
  mode: "disconnected"       # "disconnected" (default) or "always"
  store: "memory"            # "memory" or "redis"
  redis_addr: "localhost:6379"  # Required if store=redis
  ttl: "1h"                  # How long to retain events
  max_per_client: 1000       # Max events per client (FIFO eviction)
  client_expiry: "24h"       # Clear buffer if client never returns

# 1. Define How Data Enters (Ingress)
entrypoints:
  - name: "ws-users"
    type: "websocket"
    port: ":8066"
    
  - name: "sse-feed"
    type: "sse"
    port: ":8108"

# 2. Define Where Data Goes (Egress)
endpoints:
  # - name: "kafka-backend"
  #   type: "kafka"
  #   config:
  #     brokers: "redpanda:9092"
  #     topic_in: "web.ingress"
  #     topic_out: "web.egress"

  - name: "mqtt-iot"
    type: "mqtt"
    config:
      broker: "tcp://broker.hivemq.com:1883"
      topic_in: "test/pub"
      topic_out: "test/sub"

# 3. The Logic (Mediation & Flow)
# This maps sources to destinations. 
# Routes can have retention policies for delivery guarantees.
routes:
  - source: "mqtt-iot"
    destination: "sse-feed"
    policies:
      - name: "content-filter"
        type: "filter"
        config:
          block_pattern: "restricted"

  - source: "mqtt-iot"
    destination: "ws-users"
    policies:
      # Route-level retention policy (overrides global settings)
      - name: "ws-retention"
        type: "retention"
        config:
          mode: "disconnected"   # Store only when client is offline
          ttl: "30m"             # Override global TTL
          max_per_client: "500"  # Override global max

  - source: "ws-users"
    destination: "mqtt-iot"