version: v1

# Global retention settings
retention:
  enabled: true
  mode: "disconnected"       # "disconnected" (default) | "always"
  store: "memory"            # "memory" | "redis"
  redis_addr: "localhost:6379"  # Required if store=redis
  ttl: "1h"                  # How long to retain events
  max_per_client: 1000       # Max events per client (FIFO eviction)
  client_expiry: "24h"       # Clear buffer if client never returns

entrypoints:
  - name: "ws-users"
    type: "websocket"
    port: ":8066"
    
  - name: "sse-feed"
    type: "sse"
    port: ":8108"

endpoints:
  # - name: "kafka-backend"
  #   type: "kafka"
  #   config:
  #     brokers: "redpanda:9092"
  #     topic_in: "web.ingress"
  #     topic_out: "web.egress"

  - name: "mqtt-iot"
    type: "mqtt"
    config:
      broker: "tcp://broker.hivemq.com:1883"
      topic_in: "test/pub"
      topic_out: "test/sub"

  - name: mock-push 
    type: mock
    config:
      mode: "push"            # "push" | "echo" | "both"
      broadcast: "true"       # If push mode, send to all connected clients
      push_interval: "2s"
      push_prefix: "counter-"

routes:
  # - source: "mqtt-iot"
  #   destination: "sse-feed"
  #   policies:
  #     - name: "content-filter"
  #       type: "filter"
  #       config:
  #         block_pattern: "restricted"

  - source: "mock-push"
    destination: "ws-users"
    policies:
      - name: "ws-retention"
        type: "retention"        # Overrides global settings
        config:
          mode: "disconnected"   # Store only when client is offline
          ttl: "30m"             # Override global TTL
          max_per_client: "500"  # Override global max

  - source: "ws-users"
    destination: "mock-push"